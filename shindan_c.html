<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>色彩心理からのおすすめメニュー診断</title>
    <!-- ファビコンの指定 -->
    <link rel="icon" type="image/png" href="https://github.com/therapist-mii/spiritual/raw/main/images/favicon.png">

    <!-- Google Fonts: Noto Serif JPの読み込み -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS CDNを読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* カスタム設定とフォントの適用 */
        :root {
            /* サイトの装飾色 */
            --color-primary: #544C40; /* ダークブラウン系（文字、ヘッダー背景など） */
            --color-light-bg: #EAE6E1; /* メイン背景色（オフホワイト系） */
            --color-accent: #E4C1B5; /* アクセント色（温かいベージュ系） */
            --color-light-accent: #ede1e1; /* 薄い背景色 */
        }

        body {
            font-family: 'Noto Serif JP', serif;
            background-color: var(--color-light-bg);
            color: var(--color-primary);
            line-height: 1.8;
        }

        /* カスタムTailwind設定 */
        .color-circle {
            width: 40px;
            height: 40px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .color-circle:hover {
            transform: scale(1.1);
        }

        .color-circle.selected {
            box-shadow: 0 0 0 4px var(--color-accent), 0 0 0 6px var(--color-primary);
            transform: scale(1.1);
        }

        .selected-color-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background-color: var(--color-light-accent);
            border: 2px solid var(--color-accent);
            border-radius: 9999px; /* rounded-full */
            margin: 4px;
            transition: opacity 0.3s;
        }
        
        /* アニメーション */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.6s ease-out;
        }

        /* 結果カードのスタイル */
        .result-card {
            border: 1px solid var(--color-accent);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- ヘッダー -->
    <header class="shadow-lg" style="background-color: var(--color-primary);">
        <div class="container mx-auto py-5 px-4 sm:px-6 lg:px-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-white text-center">
                色彩心理からのおすすめメニュー診断
            </h1>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="container mx-auto my-8 p-4 sm:p-6 lg:p-8 flex-grow">
        
        <!-- 診断エリア -->
        <section id="diagnosis-section" class="bg-white p-6 rounded-xl shadow-2xl">
            <h2 class="text-xl sm:text-2xl font-bold mb-6 text-center border-b pb-3" style="border-color: var(--color-accent);">
                ステップ1：今のあなたを表現する色を3色選んでください
            </h2>

            <!-- 選択された色表示エリア -->
            <div class="mb-8 p-4 rounded-lg border-2" style="border-color: var(--color-accent);">
                <h3 class="text-lg font-bold mb-3" style="color: var(--color-primary);">
                    あなたの選択（3色必須）
                </h3>
                <div id="selected-colors-container" class="flex flex-wrap items-center min-h-[50px]">
                    <!-- 選択された色がここに表示されます -->
                    <p id="selection-status" class="text-sm italic" style="color: var(--color-primary); opacity: 0.7;">
                        まだ色が選択されていません。
                    </p>
                </div>
            </div>

            <!-- カラーパレット -->
            <div id="color-palette-container" class="flex flex-wrap gap-4 justify-center">
                <!-- カラーサークルはJSでここに描画されます -->
            </div>

            <!-- 診断ボタンエリア -->
            <div class="mt-8 text-center">
                <button id="diagnose-button"
                    class="py-3 px-8 font-bold text-lg rounded-full shadow-lg transition duration-300 transform disabled:opacity-50 disabled:cursor-not-allowed"
                    style="background-color: var(--color-accent); color: var(--color-primary); border: 2px solid var(--color-primary);"
                    disabled>
                    メニュー診断する
                </button>
            </div>
        </section>

        <!-- 診断結果エリア -->
        <section id="result-area" class="mt-12 hidden">
            <h2 class="text-2xl font-bold mb-6 text-center" style="color: var(--color-primary);">
                診断結果
            </h2>
            <div id="results-container" class="space-y-6">
                <!-- 結果カードがここに表示されます -->
            </div>

            <div class="mt-10 text-center space-y-4">
                <button id="re-diagnose-button"
                    class="py-2 px-6 font-bold rounded-full shadow-md transition duration-300"
                    style="background-color: var(--color-primary); color: white; border: 2px solid var(--color-primary);">
                    再診断する
                </button>
            </div>
        </section>

    </main>

    <!-- フッター -->
    <footer class="mt-12 py-8 px-4 sm:px-6 lg:px-8" style="background-color: var(--color-primary);">
        <div class="container mx-auto text-center text-white">
            <!-- フッターナビゲーション -->
            <nav class="flex flex-wrap justify-center gap-4 sm:gap-6 text-sm sm:text-base mb-6">
                <a href="https://spiritual-therapist-mii.studio.site/" class="hover:underline">HOME</a>
                <a href="https://spiritual-therapist-mii.studio.site/menu" class="hover:underline">メニュー一覧</a>
                <a href="https://spiritual-therapist-mii.studio.site/reading" class="hover:underline">リーディング</a>
                <a href="https://spiritual-therapist-mii.studio.site/mirai-navi" class="hover:underline">未来ナビ</a>
                <a href="https://spiritual-therapist-mii.studio.site/art-therapy" class="hover:underline">アートセラピー</a>
                <a href="https://spiritual-therapist-mii.studio.site/color-card" class="hover:underline">カラーカード</a>
                <a href="https://spiritual-therapist-mii.studio.site/healing" class="hover:underline">ヒーリング</a>
                <a href="https://spiritual-therapist-mii.studio.site/f2f_reading" class="hover:underline">対面リーディング</a>
            </nav>
            <p class="text-xs opacity-70">
                このサイトは色彩心理に基づいたおすすめメニュー診断を提供しています。
            </p>
        </div>
    </footer>

    <!-- JavaScript ロジック -->
    <script>
        // --- データ定義 ---

        // 診断データ
        const colorData = {
            "#FF0000": { msg: "あなたの情熱は周囲を明るく照らす力を持っています。そのエネルギーを、周りの人を鼓舞するためにぜひ使ってみましょう。", menu: "未来ナビ", reason: "今、目標達成への強い意欲があるあなたへ。「いつ、何をすべきか」という未来の地図の準備として、エネルギーを最高の成果へ導くための指針を立てるきっかけになりますよ。", linkKey: "mirai-navi" },
            "#FFE4E1": { msg: "あなたは愛と優しさで満たされています。まずは自分自身に、たっぷりその優しさを注いであげることをおすすめします。", menu: "ヒーリング", reason: "心の奥底で安心感と自己受容を求めているサインです。言葉にしづらい心の重さや疲れをそっと手放し、ご自身の全体バランスを整えるための最初の一歩を踏み出す準備ができますよ。", linkKey: "healing" },
            "#FFB6C1": { msg: "自分の持つ愛らしさや無邪気さを恥ずかしがらずに受け入れて表現してみましょう。それが、今のあなたの大きな魅力になります。", menu: "アートセラピー", reason: "人生をもっと心のままに楽しみたいという願いがあります。言語化できない「モヤモヤ」を絵で表現し、心が解放に向かうためのヒントを見つけるきっかけになるでしょう。", linkKey: "art-therapy" },
            "#FF8A80": { msg: "親しい人との温かい交流を大切にする時期です。不安や悲しみを感じたら、信頼できる人に気持ちを素直に伝えてみましょう。", menu: "ヒーリング", reason: "温かい心の繋がりと安らぎを求めていますね。守護のサポートを受けながら、心身の滞りを優しく整え、疲れた心を深い安心感で満たすための土台づくりをしましょう。", linkKey: "healing" },
            "#6B4226": { msg: "焦らず、長期的な視点を持って計画を立てましょう。「地に足をつける」感覚を取り戻すために、体を動かしてみるのもおすすめです。", menu: "未来ナビ", reason: "人生の土台を固めたいという堅実な願いが込められています。「いつ、何をすべきか」という未来予報を活用し、具体的な行動計画を立てるためのきっかけを手に入れましょう。", linkKey: "mirai-navi" },
            "#C49E7D": { msg: "これまでの経験や知識を活かし、周りの人に優しく伝えてみましょう。芸術鑑賞や読書など、心を豊かにする時間を持つことが大切です。", menu: "リーディング", reason: "内面的な豊かさや深い知恵に光が当たっています。守護霊様からの高次なメッセージは、ご自身の持つ魂の本質的な方向性を深く知るための準備段階として、大切な気づきを与えてくれます。", linkKey: "reading" },
            "#D35400": { msg: "あなたには、変化を起こすための集中力とエネルギーがあります。情熱を一点に集中させ、目標を突破する力を信じてください。", menu: "未来ナビ", reason: "停滞している状況を打破し、エネルギーを爆発させたいという強い意志があります。短期的な見通しと対策（未来予報）を活用し、目標突破のための戦略を練る準備を整えましょう。", linkKey: "mirai-navi" },
            "#FF9800": { msg: "人生は心から楽しむためにあります。あなたの持つ明るさで、周りの人にも喜びを分けてあげてください。", menu: "アートセラピー", reason: "もっと自由に、喜びを表現したいという心のサインです。言葉にならない感情を、絵を通じて解放し、深層心理に隠された「魂の本音」を発見するきっかけを見つけてみましょう。", linkKey: "art-therapy" },
            "#FFCC80": { msg: "あなたの親しみやすさは、大きな魅力です。心を開いて、周りの人との会話や交流を楽しんでみてください。", menu: "カラーリーディング", reason: "軽やかさや交流を楽しみたいという今の気分にぴったりです。色からの「メッセージのエッセンス」を手軽に知り、内省を深めるための最初のヒントを受け取れますよ。", linkKey: "color-card" },
            "#F4A261": { msg: "あなたは、自信を持って輝くことができます。あなたの個性を隠さず、積極的に表現することに意識を向けてください。", menu: "アートセラピー", reason: "「自分の個性を発揮したい」「自信を高めたい」という願いがあります。視覚的な表現を通じて、「誰も知らない自分」や埋もれていた本音を深く掘り起こすきっかけを見つけてみましょう。", linkKey: "art-therapy" },
            "#F9A825": { msg: "あなたは、物事の本質を見抜く力を持っています。深く考え、あなたの明晰な洞察力を信じて行動することをおすすめします。", menu: "リーディング", reason: "物事の本質や知的な探求心がテーマです。「思考カラーマップ」で心の状態を客観的に分析し、人生の確かな方向性を定める最初の一歩となるヒントを得られます。深い洞察は、有料セッションでさらに掘り下げていきます。", linkKey: "reading" },
            "#FDD835": { msg: "あなたの内側には、無限の可能性を秘めた閃きがあります。その大切なアイデアを、ぜひ行動に移してみましょう。", menu: "未来ナビ", reason: "現状を打破する斬新なアイデアを求めているサインです。未来予報を通じて「チャンスの最大化」を図り、ひらめきを現実の成果に結びつけるための道筋を立てる準備をしましょう。", linkKey: "mirai-navi" },
            "#ffffe6": { msg: "あなたの前には、無限の可能性が広がっています。固定観念を捨て、自由に理想の未来を描いてみましょう。", menu: "ヒーリング", reason: "「全てをリセットし、まっさらになりたい」という心の叫びです。セルフケアでは抜けきらない心の重さや詰まりを整え、新しい始まりのための土台づくりをサポートします。", linkKey: "healing" },
            "#DCE775": { msg: "急いで結果を出そうとせず、今の努力が未来の大きな実りにつながると信じて、日々の小さな変化を楽しんでください。", menu: "ヒーリング", reason: "穏やかなペースでの成長を望み、心身のリフレッシュが必要です。守護のサポートを受けながら、全体的なバランスを整えることで、着実なステップアップを応援する準備ができます。", linkKey: "healing" },
            "#EC407A": { msg: "あなたは、深い愛と喜びに満たされた存在です。その愛のエネルギーを解放し、人生を情熱的に楽しむことを自分に許可してあげてください。", menu: "アートセラピー", reason: "「生きる喜びを深く感じたい」「自己肯定感を高めたい」という情熱的なテーマです。視覚的な表現を通して、心のブロックを外し、愛のエネルギーを解放するきっかけを掴めますよ。", linkKey: "art-therapy" },
            "#F48FB1": { msg: "あなたは、優雅で洗練された美しさを持っています。自分自身を最高に美しく、丁寧に扱ってあげてください。", menu: "アートセラピー", reason: "内面と外面、両方の美しさを求める美意識の現れです。深層心理を掘り下げ、真の魅力を妨げる潜在的なブロックを解消するきっかけを見つけてみましょう。より深いトラウマケアは有料セッションでご提供します。", linkKey: "art-therapy" },
            "#F8BBD0": { msg: "あなたは、優しさと癒やしの力に満ちています。疲れた自分を許し、温かい思いやりを注いでみましょう。", menu: "ヒーリング", reason: "心身の疲れを癒やし、リラックスしたいという強い願いがあります。言葉にしづらい心身の「だるさ・重さ」を整え、自己受容を深めるための優しい準備ができますよ。", linkKey: "healing" },
            "#FFF0F5": { msg: "あなたの夢と、そこにある純粋な愛を信じてください。その気持ちが、あなたの未来を美しく彩るでしょう。", menu: "アートセラピー", reason: "純粋な愛の感情や、理想的な未来を描きたいという願いが込められています。深層心理分析で「魂の本音」を知り、人生で大切にすべきことを明確にするヒントを得られます。", linkKey: "art-therapy" },
            "#FFFAFA": { msg: "あなたは、縛られることなく自由になることができます。自分の心の声に従って、軽やかに行動してみましょう。", menu: "ヒーリング", reason: "過去の感情的な重荷から解放され、軽やかになりたいという強いサインです。心身の「詰まり」を整え、エネルギーを浄化することで、より自由に羽ばたく準備が整います。", linkKey: "healing" },
            "#E6E6FA": { msg: "あなたの内側には、深い静けさと高貴な精神性があります。静かな時間を作り、内面からのメッセージを受け取ってみてください。", menu: "リーディング", reason: "日々の喧騒から離れ、精神的な平和とインスピレーションを求めています。「魂が本当に望むこと」など、人生の本質的な方向性を知る高次なメッセージに触れるきっかけになります。", linkKey: "reading" },
            "#CE93D8": { msg: "あなたは、そのままで十分完璧な存在です。欠点も含めて自分自身を深く受け入れ、優しさを周りの人にも分けてあげてください。", menu: "ヒーリング", reason: "自分自身の全てを受け入れたいという癒やしのテーマです。自己治癒力が働く土台づくりをすることで、内なる癒やしが深まり、自己受容のプロセスが穏やかに進む準備ができます。", linkKey: "healing" },
            "#8E24AA": { msg: "あなたには、自分を変えるための、計り知れない精神的な力が備わっています。その力を信じ、内なる変革を始めてみませんか。", menu: "リーディング", reason: "現状から脱却し、「本当の自分」に生まれ変わりたいという根源的な願いがあります。スピリチュアルな視点から、あなたの人生の深い意味と方向性を知る最初の一歩となるでしょう。", linkKey: "reading" },
            "#6A1B9A": { msg: "あなたの高い理想は、実現可能です。直感を信じ、その知恵を活かして、一歩ずつ現実のものにしていきましょう。", menu: "未来ナビ", reason: "高い理想やビジョンの実現が目前です。具体的な未来予報を通じて「チャンスの最大化」を図り、理想を実現するための行動を後押しする指針を立てることができます。", linkKey: "mirai-navi" },
            "#3F3F74": { msg: "あなたの知性と規律は、あなた自身を守る盾となります。感情に流されず、冷静に計画を実行することをおすすめします。", menu: "リーディング", reason: "感情の波に左右されない強い自分になりたいという願いがあります。「思考カラーマップ」で心の状態を客観的に分析し、冷静で理性的な「自分軸」を確立する準備をお手伝いします。", linkKey: "reading" },
            "#2196F3": { msg: "あなたの創造性は無限大です。心を解き放ち、感じたこと、考えたことを自由に表現してみましょう。", menu: "アートセラピー", reason: "自由な発想と、オープンな自己表現がテーマです。言葉にできない創造的なエネルギーを「絵や筆跡」で表すことで、あなたの心を深く解放し、スッキリ感を味わうきっかけを掴めます。", linkKey: "art-therapy" },
            "#1976D2": { msg: "あなたの信念と誠実さは、本物です。その信念を貫き、周りの人からの信頼の証として行動で示しましょう。", menu: "未来ナビ", reason: "自分の信念に基づいて行動し、責任を果たしたいという強い思いがあります。「リスクマネジメント」や「具体的な対策」など、堅実な行動を支える指針を立てるきっかけを掴みましょう。", linkKey: "mirai-navi" },
            "#BBDEFB": { msg: "あなたの心は、穏やかで平和な状態に戻ろうとしています。焦らず、その自然な流れに身を任せてあげてください。", menu: "ヒーリング", reason: "心に平和と静けさを求め、リラックスしたいというサインです。心のざわつきや、セルフケアでは抜けない心の詰まりを整え、穏やかで安心できる状態へ戻る土台づくりをサポートします。", linkKey: "healing" },
            "#000080": { msg: "あなたの内側には、全てを知る深い知恵があります。静かな時間を作り、瞑想を通じてその声に耳を傾けてみましょう。", menu: "リーディング", reason: "人生の深い意味や、内なる真実を知りたいという探求心があります。「魂が本当に望むこと」を知り、自分の内面にある真の力を引き出すメッセージのヒントを受け取ってみませんか。", linkKey: "reading" },
            "#B2EBF2": { msg: "あなたの心は、風のように自由で清らかです。肩の力を抜き、軽やかに、思うままに羽ばたいてみましょう。", menu: "カラーリーディング", reason: "束縛から解放され、軽やかになりたいという願いがあります。日常の中で「ちょっとした指針」となるメッセージを手軽に受け取り、内省を始めるきっかけにするのに最適です。", linkKey: "color-card" },
            "#1ABC9C": { msg: "あなたの心は、今、調和を取り戻そうとしています。無理せず、心と体の声に耳を傾け、バランスの取れた生活を心がけてください。", menu: "ヒーリング", reason: "心と体のバランス、穏やかな調和がテーマです。心身の滞りやモヤを整え、守護のサポートを受けながら、全体的なバランスを回復させるための準備をします。", linkKey: "healing" },
            "#43A047": { msg: "あなたの努力は、必ず実を結びます。急いで結果を求めず、日々の成長と小さな達成を楽しむことに意識を向けてください。", menu: "未来ナビ", reason: "焦らず着実に進みたいという願いがあります。未来予報で「リスクマネジメント」や「チャンスの最大化」を計画し、努力を確実な実りへと導く指針を立てる準備をしていきましょう。", linkKey: "mirai-navi" },
            "#AEEA00": { msg: "あなたの人生は、今、新しい成長期に入っています。好奇心とユーモアを持って、目の前の課題に飛び込んでみましょう。", menu: "カラーリーディング", reason: "活発な成長と、新しいアイデアを求めているサインです。「メッセージのエッセンス」を受け取り、その「余白」をご自身で読み解くことで、内省と成長を楽しむきっかけが得られますよ。", linkKey: "color-card" },
            "#f3ffd1": { msg: "あなたは、そのままで十分魅力的です。肩の力を抜き、ありのままの自分でいることを自分に許可してあげてください。", menu: "カラーリーディング", reason: "義務やプレッシャーから解放され、自然体で過ごしたいという願いがあります。安価に、日常の中で「ちょっとした指針」を受け取り、軽やかに心身を整えるためのヒントにするのに最適です。", linkKey: "color-card" },
            "#E0E1DD": { msg: "あなたは、感情から一歩引いて物事を眺めることができる、賢明な人です。あなたの客観的な視点を信じて行動してください。", menu: "リーディング", reason: "感情に流されず、冷静な知性を求めています。「思考カラーマップ」で心の状態を客観的に分析し、理性と知恵を持って人生の方向性を定めるための最初のヒントが得られます。", linkKey: "reading" },
            "#6D6D6D": { msg: "あなたの内側には、しっかりと確立された「自分軸」があります。周りの意見に惑わされず、自分の価値観を信じてください。", menu: "リーディング", reason: "他者に依存せず、自分の軸を確立したいという強い願いがあります。魂が本当に望むことなど、本質的な人生の方向性を知り、揺るぎない「自分軸」を強化する準備ができます。", linkKey: "reading" },
            "#3A3A3A": { msg: "あなたの中には、物事の全てを受け止め、支える基盤となる力強さがあります。恐れず、自分の深い部分と向き合ってみましょう。", menu: "リーディング", reason: "揺るぎない基盤を築きたいという強い思いがあります。漠然とした「悩み事」や「人生の迷い」があるなら、スピリチュアルな視点から本質的な人生の方向性を見つけるための最初のヒントを受け取れます。", linkKey: "reading" },
            "#FFFFFF": { msg: "あなたは、無限の可能性と、純粋な光に満ちた存在です。過去の全てを許し、理想の未来を自由に描いていきましょう。", menu: "未来ナビ", reason: "最高の理想と新しい人生の始まりという未来志向のテーマです。未来予報を活用して「チャンスの最大化」を図り、理想の未来を現実のものにするための具体的な行動計画を立てる準備をしましょう。", linkKey: "mirai-navi" }
        };

        // メニュー詳細・予約リンクのマッピング
        const linkMap = {
            "reading": "https://spiritual-therapist-mii.studio.site/reading",
            "mirai-navi": "https://spiritual-therapist-mii.studio.site/mirai-navi",
            "art-therapy": "https://spiritual-therapist-mii.studio.site/art-therapy",
            "color-card": "https://spiritual-therapist-mii.studio.site/color-card",
            "healing": "https://spiritual-therapist-mii.studio.site/healing",
            "f2f-reading": "https://spiritual-therapist-mii.studio.site/f2f_reading",
            // 予約リンク
            "reading-r": "https://spiritual-therapist-mii.studio.site/reading-r",
            "mirai-navi-r": "https://spiritual-therapist-mii.studio.site/mirai-navi-r",
            "art-therapy-r": "https://spiritual-therapist-mii.studio.site/art-therapy-r",
            "color-card-r": "https://spiritual-therapist-mii.studio.site/color-card-r",
            "healing-r": "https://spiritual-therapist-mii.studio.site/healing#h-yoyaku",
            "f2f-reading-r": "https://spiritual-therapist-mii.studio.site/f2f-reading-r",
        };


        // --- DOM要素 ---
        const paletteContainer = document.getElementById('color-palette-container');
        const selectedContainer = document.getElementById('selected-colors-container');
        const diagnoseButton = document.getElementById('diagnose-button');
        const reDiagnoseButton = document.getElementById('re-diagnose-button');
        const resultArea = document.getElementById('result-area');
        const resultsContainer = document.getElementById('results-container');
        const selectionStatus = document.getElementById('selection-status');

        // --- 状態管理 ---
        let selectedColors = []; // 選択された色のコードを格納 (最大3つ)

        /**
         * 診断ボタンの状態を更新し、選択状態のメッセージを更新する
         */
        function updateSelectionState() {
            // 選択数が3つでなければボタンを無効化、3つであれば有効化
            diagnoseButton.disabled = selectedColors.length !== 3;

            // 選択状態のメッセージを更新
            if (selectedColors.length === 0) {
                selectionStatus.textContent = 'まだ色が選択されていません。';
                selectionStatus.classList.remove('hidden');
            } else if (selectedColors.length < 3) {
                selectionStatus.textContent = `あと${3 - selectedColors.length}色選んでください。`;
                selectionStatus.classList.remove('hidden');
            } else {
                selectionStatus.classList.add('hidden');
            }
        }

        /**
         * カラーパレットのレンダリング
         */
        function renderMainPalette() {
            Object.keys(colorData).forEach(colorCode => {
                const circle = document.createElement('div');
                circle.className = 'color-circle rounded-full transition duration-300 transform';
                circle.style.backgroundColor = colorCode;

                // 明るい色の場合は黒の枠線を追加 (例: 白系の色)
                const isLight = (parseInt(colorCode.substring(1, 7), 16) > 0xcccccc);
                if (isLight) {
                    circle.style.border = '1px solid #ccc';
                }

                circle.setAttribute('data-color', colorCode);
                circle.addEventListener('click', () => handleColorClick(colorCode));
                paletteContainer.appendChild(circle);
            });
        }

        /**
         * 選択された色コンテナのレンダリング
         */
        function renderSelectedColors() {
            // コンテナをクリア
            selectedContainer.innerHTML = '';

            if (selectedColors.length > 0) {
                selectedColors.forEach(colorCode => {
                    const item = document.createElement('div');
                    item.className = 'selected-color-item';
                    
                    const swatch = document.createElement('div');
                    swatch.className = 'w-4 h-4 rounded-full mr-2 flex-shrink-0';
                    swatch.style.backgroundColor = colorCode;

                    // 白い色の場合に枠線を追加
                    if (colorCode === '#FFFFFF' || colorCode === '#ffffe6' || colorCode === '#FFF0F5' || colorCode === '#FFFAFA') {
                        swatch.style.border = '1px solid #ccc';
                    }

                    const removeButton = document.createElement('button');
                    removeButton.innerHTML = 'X';
                    removeButton.className = 'ml-3 w-5 h-5 flex items-center justify-center text-xs font-bold rounded-full transition duration-150 hover:bg-gray-200';
                    removeButton.style.color = colorCode === '#FFFFFF' ? 'var(--color-primary)' : 'var(--color-primary)';
                    removeButton.addEventListener('click', () => removeColor(colorCode));

                    item.appendChild(swatch);
                    item.appendChild(removeButton);
                    selectedContainer.appendChild(item);
                });
            }

            // パレットのサークルの選択状態を更新
            document.querySelectorAll('.color-circle').forEach(circle => {
                const colorCode = circle.getAttribute('data-color');
                if (selectedColors.includes(colorCode)) {
                    circle.classList.add('selected');
                } else {
                    circle.classList.remove('selected');
                }
            });
            updateSelectionState();
        }

        /**
         * 色の選択/解除を処理
         * @param {string} colorCode - 選択された色のHEXコード
         */
        function handleColorClick(colorCode) {
            const index = selectedColors.indexOf(colorCode);

            if (index > -1) {
                // 既に選択されている場合は解除 (removeColorを呼び出す)
                removeColor(colorCode);
            } else if (selectedColors.length < 3) {
                // 3色未満の場合は追加
                selectedColors.push(colorCode);
                renderSelectedColors();
            } else {
                // 3色超えの場合は何もしない（アラートは使わない）
                console.warn('3色までしか選択できません。');
            }
        }

        /**
         * 選択された色を削除
         * @param {string} colorCode - 削除する色のHEXコード
         */
        function removeColor(colorCode) {
            selectedColors = selectedColors.filter(c => c !== colorCode);
            renderSelectedColors();
            // 結果が表示されている場合は非表示にする
            resultArea.classList.add('hidden');
        }

        /**
         * 診断を実行し、結果を表示
         */
        function runDiagnosis() {
            if (selectedColors.length !== 3) {
                // 3色が選択されていない場合は警告を出して処理を中断
                alert('診断を行うには、3色を正確に選択してください。'); // カスタムアラートの代替として一時的に使用
                return;
            }

            // 1. 総合メッセージとメニューの集計
            let allMessages = '';
            const menuCounts = {};
            let firstMenuData = null; // おすすめ理由抽出のための最初のデータ

            selectedColors.forEach(colorCode => {
                const data = colorData[colorCode];
                if (data) {
                    // 総合メッセージに追加
                    allMessages += `<p>${data.msg}</p>`;

                    // メニューカウント
                    menuCounts[data.menu] = (menuCounts[data.menu] || 0) + 1;

                    // 最初に該当するメニューのデータを保持 (タイブレークと理由取得のため)
                    if (!firstMenuData || (menuCounts[data.menu] === 1 && !firstMenuData[data.menu])) {
                        if (!firstMenuData) firstMenuData = {};
                        firstMenuData[data.menu] = data;
                    }
                }
            });

            // 2. 一番おすすめなメニューの決定
            let bestMenu = '';
            let maxCount = 0;
            
            // カウントが最大のメニューを見つける (タイブレークは最初に見つかったもの)
            for (const menu in menuCounts) {
                if (menuCounts[menu] > maxCount) {
                    maxCount = menuCounts[menu];
                    bestMenu = menu;
                }
            }

            // 3. 決定したメニューの詳細情報を取得
            // bestMenuDataは、選ばれたメニューに最初に対応した色データ
            let bestMenuDetails = null;
            selectedColors.forEach(colorCode => {
                const data = colorData[colorCode];
                if (data && data.menu === bestMenu && !bestMenuDetails) {
                    bestMenuDetails = data;
                }
            });

            if (!bestMenuDetails) {
                console.error("診断結果のメニュー詳細が見つかりませんでした。");
                return; // 致命的なエラー
            }

            const detailUrl = linkMap[bestMenuDetails.linkKey] || '#';
            const reserveUrl = linkMap[bestMenuDetails.linkKey + '-r'] || '#';
            
            // 4. 結果表示エリアの更新
            resultsContainer.innerHTML = '';
            resultArea.classList.remove('hidden');

            // 1. おすすめメニューサマリーカード
            const summaryCard = document.createElement('div');
            summaryCard.className = 'result-card p-6 rounded-xl shadow-lg animate-fadeIn bg-white';
            summaryCard.innerHTML = `
                <h3 class="text-xl sm:text-2xl font-bold mb-4 text-center" style="color: var(--color-primary);">
                    <span class="p-2 rounded-md" style="background-color: var(--color-accent);">✨ 一番おすすめなメニュー ✨</span>
                </h3>
                
                <p class="text-3xl font-bold text-center mb-6" style="color: var(--color-primary);">${bestMenu}</p>
                
                <div class="mb-6 p-4 rounded-lg" style="background-color: var(--color-light-accent); border: 1px solid var(--color-accent);">
                    <h4 class="text-lg font-bold mb-2 border-b pb-1" style="border-color: var(--color-accent); color: var(--color-primary);">
                        おすすめ理由
                    </h4>
                    <p class="text-base leading-relaxed">${bestMenuDetails.reason}</p>
                </div>
                
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <a href="${detailUrl}" target="_blank"
                        class="text-center font-bold py-3 px-6 rounded-full shadow-md transition duration-300"
                        style="background-color: var(--color-accent); color: var(--color-primary); border: 2px solid var(--color-primary); hover:opacity-80;">
                        メニュー詳細を見る
                    </a>
                    <a href="${reserveUrl}" target="_blank"
                        class="text-center font-bold py-3 px-6 rounded-full shadow-md transition duration-300"
                        style="background-color: var(--color-primary); color: white; hover:opacity-80;">
                        予約する
                    </a>
                </div>
            `;
            resultsContainer.appendChild(summaryCard);

            // 2. 総合メッセージカード
            const messageCard = document.createElement('div');
            messageCard.className = 'result-card p-6 rounded-xl shadow-lg animate-fadeIn bg-white';
            messageCard.style.animationDelay = '0.2s';
            messageCard.innerHTML = `
                <h4 class="text-xl font-bold mb-3 border-b pb-2" style="border-color: var(--color-accent); color: var(--color-primary);">
                    選ばれた3色からの総合的なメッセージ
                </h4>
                <div class="text-base p-4 leading-relaxed space-y-4" style="background-color: var(--color-light-accent); border-left: 5px solid var(--color-accent);">
                    ${allMessages}
                </div>
            `;
            resultsContainer.appendChild(messageCard);
            
            // 結果エリアへスクロール
            const diagnosisSection = document.getElementById('diagnosis-section');
            diagnosisSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        /**
         * 診断をリセットする
         */
        function resetDiagnosis() {
            selectedColors = []; // 選択をクリア
            renderSelectedColors(); // UIを更新
            resultArea.classList.add('hidden'); // 結果エリアを非表示
            // 診断セクションの先頭へスクロール
            document.getElementById('diagnosis-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }


        // --- イベントリスナーの設定 ---
        diagnoseButton.addEventListener('click', runDiagnosis);
        reDiagnoseButton.addEventListener('click', resetDiagnosis);

        // 初期化処理
        document.addEventListener('DOMContentLoaded', () => {
            renderMainPalette();
            updateSelectionState(); // 初期状態でボタンを無効化
        });
    </script>
</body>
</html>

