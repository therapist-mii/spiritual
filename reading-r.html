<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>リーディングお見積り＆ご予約</title>
  <link rel="icon" href="https://github.com/therapist-mii/spiritual/raw/main/images/favicon.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --text:#776163;
      --error:#ff0000;
      --btn:#E4C1B5;                 /* 通常ボタン */
      --btn-hover:#ad9196;           /* ホバー時背景 */
      --btn-hover-text:#ffffff;      /* ホバー時テキスト */
      --first-btn:#e4b5b9;           /* はじめての方フォームボタン */
      --first-btn-hover:#ad9196;     /* はじめての方フォームボタン ホバー */
      --clear-bg:#EAE6E1;            /* 下部 クリアボタン 背景 */
      --clear-text:#cbb6b6;          /* 下部 クリアボタン テキスト */
      --clear-hover-bg:#cbb6b6;      /* 下部 クリアボタン ホバー背景 */
      --clear-hover-text:#EAE6E1;    /* 下部 クリアボタン ホバーテキスト */
      --card-clear-bg:#7a736a;       /* カードの×ボタン 背景 */
      --card-clear-text:#ffffff;     /* カードの×ボタン テキスト */
      --card-clear-hover-bg:#E4C1B5; /* カードの×ボタン ホバー背景 */
      --surface:#fff;
      --surface-2:#F7F3EF;
      --line:#E9E1DB;
    }
    html,body{height:100%;}
    body{
      margin:0; color:var(--text); background:
        radial-gradient(1200px 800px at 100% -10%, rgba(228,193,181,.25), transparent 60%),
        radial-gradient(1000px 700px at -10% 110%, rgba(237,229,222,.5), transparent 60%),
        #FCFAF7;
      font-family:"Noto Serif JP", serif;
      letter-spacing:.02em;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
      scroll-behavior:smooth;
    }
    a{color:inherit;}
    .wrap{max-width:960px; margin:0 auto; padding:20px 16px 80px;}

    /* ヘッダー */
    header{position:sticky; top:0; z-index:20; background:linear-gradient(to bottom, rgba(252,250,247,.95), rgba(252,250,247,.85)); backdrop-filter:saturate(120%) blur(6px); border-bottom:1px solid var(--line);} 
    header .inner{max-width:960px; margin:0 auto; padding:10px 16px; display:flex; align-items:center; justify-content:center;}
    header img{display:block; height:auto; /* 指定: 加工なし・サイズそのまま */}

    h1{font-size:1.4rem; margin:14px 0 6px; text-align:center; font-weight:700;}
    .lead{font-size:.95rem; text-align:center; margin:0 0 18px;}

    /* 共通UI */
    .section{background:var(--surface); border:1px solid var(--line); border-radius:16px; padding:16px; margin:14px 0; box-shadow:0 8px 20px rgba(0,0,0,.03);}
    .section-title{font-weight:700; font-size:1.05rem; margin:0 0 10px;}
    .desc{font-size:.85rem; opacity:.9; margin:6px 0 10px;}

    label{display:block; font-size:.95rem; font-weight:600; margin:14px 0 8px;}
    .req{color:var(--error); margin-left:4px; font-weight:700;}
    input[type="text"], textarea, select{width:100%; border:1px solid var(--line); background:#fff; border-radius:12px; padding:12px 12px; font:inherit; color:var(--text); box-sizing:border-box; outline:none; transition:border-color .2s ease, box-shadow .2s ease;}
    textarea{min-height:112px; resize:vertical;}
    input[type="text"]:focus, textarea:focus, select:focus{border-color:#d7c7be; box-shadow:0 0 0 4px rgba(228,193,181,.25);} 
    .error{border-color:var(--error)!important; box-shadow:0 0 0 4px rgba(255,0,0,.08)!important;}

    .row{display:grid; gap:10px;}
    @media (min-width:640px){.row-2{grid-template-columns:1fr 1fr;} .row-3{grid-template-columns:1fr 1fr 1fr;}}

    .btn{appearance:none; border:none; border-radius:999px; padding:12px 18px; font:inherit; color:var(--text); background:var(--btn); cursor:pointer; transition:transform .06s ease, background .2s ease, color .2s ease; box-shadow:0 4px 14px rgba(0,0,0,.06);} 
    .btn:hover{background:var(--btn-hover); color:var(--btn-hover-text);} 
    .btn:active{transform:translateY(1px);} 
    .btn-ghost{background:transparent; border:1px solid var(--line);} 
    .btn-clear{background:var(--clear-bg); color:var(--clear-text);} 
    .btn-clear:hover{background:var(--clear-hover-bg); color:var(--clear-hover-text);} 

    /* カード */
    .card{position:relative; background:var(--surface-2); border:1px solid var(--line); border-radius:16px; padding:14px; margin:14px 0; overflow:hidden;}
    .card .floating-clear{position:absolute; right:10px; top:10px; width:34px; height:34px; border-radius:999px; background:var(--card-clear-bg); color:var(--card-clear-text); display:grid; place-items:center; font-weight:700; cursor:pointer; transition:background .2s ease;}
    .card .floating-clear:hover{background:var(--card-clear-hover-bg);} 
    .muted{font-size:.82rem; opacity:.85;}
    .helper{font-size:.8rem; opacity:.75; margin-top:4px;}

    /* 関係者 */
    .persons{margin-top:10px;}
    .person{display:grid; gap:8px; grid-template-columns:1fr; margin:10px 0; animation:fadeUp .35s ease both;} 
    @media (min-width:560px){.person{grid-template-columns:1.2fr 0.8fr;}}
    .persons .controls{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:6px;}
    .count{font-size:.85rem;}

    /* 見積ボックス */
    .estimate{background:#fff; border:1px solid var(--line); border-radius:16px; padding:14px; white-space:pre-line; line-height:1.8;}
    .separator{margin:10px 0; border-top:1px dashed #d9cfc7;}

    /* フッター */
    footer{margin-top:40px; border-top:1px solid var(--line); padding:20px 16px; text-align:center;}
    .footer-logo{display:block; margin:12px auto 8px; height:auto;}
    .footer-links{display:flex; gap:16px; justify-content:center; flex-wrap:wrap; font-size:.95rem; margin-top:8px;}

    /* モーション */
    .fade-in{animation:fadeIn .5s ease both;} 
    .fade-up{animation:fadeUp .5s ease both;} 
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes fadeUp{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none}}

    .center{display:flex; justify-content:center;}
    .space{height:10px;}
  </style>
</head>
<body>
  <!-- ヘッダー -->
  <header class="fade-in" aria-label="ヘッダー">
    <div class="inner">
      <a href="https://spiritual-therapist-mii.studio.site/" target="_blank" rel="noopener">
        <!-- 指定: ロゴに加工なし・サイズそのまま使用 -->
        <img src="https://github.com/therapist-mii/spiritual/raw/main/images/rogo-250.png" alt="Spiritual Therapist Mii ロゴ" />
      </a>
    </div>
  </header>

  <div class="wrap">
    <h1 class="fade-up">リーディングお見積り＆ご予約</h1>
    <p class="lead fade-up">必要事項を記入してください。一番下に見積もりが出ます。</p>

    <form id="form" novalidate>
      <!-- ご相談カード群 -->
      <section class="section" aria-labelledby="consult-title">
        <h2 id="consult-title" class="section-title">ご相談内容</h2>
        <p class="desc">相談内容の要点のみご記入ください。詳細はLINEにてお知らせください。</p>

        <div id="cards"></div>

        <div class="center" style="margin-top:10px">
          <button type="button" id="addConsult" class="btn" aria-label="相談を追加">相談を追加</button>
        </div>
      </section>

      <!-- オプション -->
      <section class="section" aria-labelledby="opt-title">
        <h2 id="opt-title" class="section-title">オプション</h2>

        <div class="row">
          <div>
            <div><strong>筆跡診断</strong></div>
            <div class="desc">文字の癖から思考傾向や内面のブロックを診断します。 6,000円</div>
            <button type="button" class="btn opt-toggle" data-key="handwriting">追加する</button>
          </div>
          <div>
            <div><strong>お顔オーラカラーマップ</strong></div>
            <div class="desc">お顔に現れるエネルギー傾向をカラーマップで可視化します。 4,000円</div>
            <button type="button" class="btn opt-toggle" data-key="faceAura">追加する</button>
          </div>
        </div>
      </section>

      <!-- お支払い/割引・備考 -->
      <section class="section" aria-labelledby="pay-title">
        <h2 id="pay-title" class="section-title">お支払いについて</h2>

        <div class="row row-2">
          <div>
            <label for="coupon">クーポン</label>
            <div class="desc">クーポンをお持ちの方は選択してください。</div>
            <select id="coupon" name="coupon">
              <option value="none">選択してください</option>
              <option value="0">クーポン無し</option>
              <option value="5">5％OFFクーポン</option>
              <option value="10">10％OFFクーポン</option>
              <option value="15">15％OFFクーポン</option>
              <option value="20">20％OFFクーポン</option>
              <option value="25">25％OFFクーポン</option>
              <option value="30">30％OFFクーポン</option>
            </select>
          </div>
          <div>
            <label>紹介割引</label>
            <div class="desc">ご紹介くださった方と紹介された方を対象に割引できます。他クーポン併用可 紹介割引：−500円</div>
            <button type="button" class="btn opt-toggle" data-key="referral">追加する</button>
          </div>
        </div>

        <div class="row row-2">
          <div>
            <label>ライト割引</label>
            <div class="desc">A4用紙1枚程度の量の鑑定書のみ...5,000円引き。納品後のLINEは、お気持ちだけいただき、基本的にこちらからのご返信は控えさせていただきます。</div>
            <button type="button" class="btn opt-toggle" data-key="light">追加する</button>
          </div>
          <div>
            <label for="pay"><span>お支払い方法</span><span class="req">*</span></label>
            <select id="pay" name="pay" required aria-required="true">
              <option value="">選択してください</option>
              <option>銀行振込</option>
              <option>Paypay</option>
              <option>Paypal</option>
              <option>クレジットカード</option>
              <option>コンビニ払い（手数料220円）</option>
            </select>
          </div>
        </div>

        <div>
          <label for="note">備考</label>
          <div class="desc">ご希望・ご質問があればご記入ください</div>
          <textarea id="note" name="note" placeholder="例：〇月△日までに納品希望 など"></textarea>
        </div>
      </section>

      <!-- ご確認事項 -->
      <section class="section" aria-labelledby="confirm-title">
        <h2 id="confirm-title" class="section-title">ご確認事項</h2>

        <div class="desc"><strong>セッションについて</strong><br>セッション形式： 遠隔／ ご予約： 日にち指定のみ（時間指定不可）</div>

        <div class="desc"><strong>納品日・営業時間</strong><br>納品日：セッション日より5営業日<br>営業時間： 9：00～17：00<br>休日：土日祝日、他指定日</div>

        <div class="desc"><strong>セッション後の追加料金について</strong><br>納品後に、追加の相談がある場合、追加料金が発生いたします。<br>ご相談１件：3,000円～</div>

        <div class="desc"><strong>【ご提出いただくもの】</strong><br>目元の写真／手書きのお名前／手書きの相談のタイトル</div>

        <div class="row row-2" style="margin-top:8px; gap:14px; align-items:center">
          <img src="https://github.com/therapist-mii/spiritual/raw/main/images/memoto.jpg" alt="目元の写真 見本" style="width:100%; border-radius:12px; border:1px solid var(--line);"/>
          <img src="https://github.com/therapist-mii/spiritual/raw/main/images/tegaki-r.jpg" alt="手書きの見本" style="width:100%; border-radius:12px; border:1px solid var(--line);"/>
        </div>
      </section>

      <!-- 自動見積り -->
      <section class="section" aria-labelledby="est-title">
        <h2 id="est-title" class="section-title">自動計算・表示</h2>
        <div id="estimate" class="estimate" aria-live="polite">（入力に応じて自動で表示されます）</div>
      </section>

      <!-- 機能ボタン -->
      <section class="section" aria-label="機能ボタン">
        <div class="row">
          <div class="center" style="gap:10px; flex-wrap:wrap">
            <button type="button" id="clearAll" class="btn btn-clear">クリア</button>
            <button type="button" id="copyBtn" class="btn">コピーボタン</button>
            <button type="button" id="lineBtn" class="btn">LINEに貼り付けて予約する</button>
          </div>
        </div>
        <div class="desc" style="margin-top:10px">
          <strong>【LINEで予約する際の手順】</strong><br>
          ① お見積り内容にご了承いただけましたら、コピーボタンを押し、お見積り内容をコピーしてください。<br>
          ② 「LINEに貼り付けて予約する」ボタンを押し、起動したLINEに貼り付けて送信ください。
        </div>
      </section>
    </form>

    <!-- フッター -->
    <footer>
      <div class="section" style="display:inline-block; text-align:left;">
        <div class="section-title">はじめての方へ</div>
        <div class="desc">はじめての方は、以下のフォームにご記入お願いいたします。<br>リピーター様も未入力の方はご記入お願いいたします。</div>
        <div class="center" style="margin-top:6px">
          <a class="btn" style="background:var(--first-btn)" href="https://spiritual-therapist-mii.studio.site/form" target="_blank" rel="noopener" onmouseover="this.style.background='var(--first-btn-hover)'; this.style.color='#fff'" onmouseout="this.style.background='var(--first-btn)'; this.style.color='var(--text)'">はじめての方のフォーム</a>
        </div>
      </div>

      <a href="https://spiritual-therapist-mii.studio.site/" target="_blank" rel="noopener"><img class="footer-logo" src="https://github.com/therapist-mii/spiritual/raw/main/images/rogo-250.png" alt="ロゴ" /></a>
      <nav class="footer-links" aria-label="フッターメニュー">
        <a href="https://spiritual-therapist-mii.studio.site/" target="_blank" rel="noopener">Home</a>
        <a href="https://spiritual-therapist-mii.studio.site/menu" target="_blank" rel="noopener">メニュー一覧</a>
      </nav>
    </footer>
  </div>

  <script>
  (()=>{
    const BASE = 16000;
    const ADDITIONAL = 3000;
    const PERSON_FEES = { family:1500, love:5000, other:3000 };
    const OPTION_FEES = { handwriting:6000, faceAura:4000 };

    const cardContainer = document.getElementById('cards');
    const addConsultBtn = document.getElementById('addConsult');
    const estimateEl = document.getElementById('estimate');
    const couponSel = document.getElementById('coupon');
    const paySel = document.getElementById('pay');

    const toggles = { handwriting:false, faceAura:false, referral:false, light:false };

    // 初期カード作成
    addConsultCard(false);
    recalc();

    // イベント: 相談追加
    addConsultBtn.addEventListener('click', ()=>{
      if(document.querySelectorAll('.consult-card').length >= 5){
        alert('追加できるご相談は最大5件までです。');
        return;
      }
      addConsultCard(true);
      recalc();
    });

    // オプション/割引トグル
    document.querySelectorAll('.opt-toggle').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const key = btn.dataset.key;
        toggles[key] = !toggles[key];
        btn.textContent = toggles[key] ? '追加済み（取り消す）' : '追加する';
        recalc();
      })
    });

    // クーポン変更
    couponSel.addEventListener('change', recalc);
    paySel.addEventListener('change', ()=>{ removeError(paySel); recalc(); });

    // クリア（全体）
    document.getElementById('clearAll').addEventListener('click', ()=>{
      if(!confirm('入力内容をすべて消去します。よろしいですか？')) return;
      // カードを初期化
      cardContainer.innerHTML='';
      addConsultCard(false);
      // オプション・割引
      Object.keys(toggles).forEach(k=> toggles[k]=false);
      document.querySelectorAll('.opt-toggle').forEach(btn=> btn.textContent='追加する');
      // クーポン・支払い・備考
      couponSel.value='none';
      paySel.value='';
      document.getElementById('note').value='';
      recalc();
      window.scrollTo({top:0, behavior:'smooth'});
    });

    // コピーボタン
    document.getElementById('copyBtn').addEventListener('click', async ()=>{
      const ok = validate();
      if(!ok) return;
      const text = buildEstimateText();
      try{
        await navigator.clipboard.writeText(text);
        alert('お見積り内容をコピーしました。LINEに貼り付けて送信してください。');
      }catch(e){
        // フォールバック
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        alert('お見積り内容をコピーしました。LINEに貼り付けて送信してください。');
      }
    });

    // LINEボタン
    document.getElementById('lineBtn').addEventListener('click', ()=>{
      const ok = validate();
      if(!ok) return;
      window.location.href = 'https://line.me/ti/p/Kv76GQK_UI';
    });

    // ------ 関数群 ------
    function addConsultCard(withClear){
      const idx = document.querySelectorAll('.consult-card').length + 1;
      const card = document.createElement('article');
      card.className = 'card consult-card fade-up';
      card.dataset.index = String(idx);
      card.innerHTML = `
        ${withClear ? '<button type="button" class="floating-clear" aria-label="この相談をクリア">×</button>' : ''}
        <label>ご相談内容<span class="req">*</span></label>
        <div class="helper">相談内容の要点のみご記入ください。詳細はLINEにてお知らせください。</div>
        <textarea class="consult-text" placeholder="例：守護霊様からのメッセージをお願いします" required aria-required="true"></textarea>

        <div class="persons" data-count="0">
          <label>ご相談内容に関係する方</label>
          <div class="helper">人間関係のご相談など、鑑定結果に言及する必要のある方のお名前（ニックネーム可）。最大5名まで</div>
          <div class="person-list"></div>
          <div class="controls">
            <button type="button" class="btn add-person">関係者を追加</button>
            <span class="count">人数: <b class="num">0</b> 人</span>
          </div>
        </div>
      `;

      // 追加
      cardContainer.appendChild(card);

      // 相談テキスト変更で再計算
      card.querySelector('.consult-text').addEventListener('input', ()=>{ removeError(card.querySelector('.consult-text')); recalc(); });

      // 関係者追加
      const addBtn = card.querySelector('.add-person');
      const list = card.querySelector('.person-list');
      const numLabel = card.querySelector('.num');
      addBtn.addEventListener('click', ()=>{
        const current = list.querySelectorAll('.person').length;
        if(current >= 5){ alert('関係者は最大5名まで追加できます。'); return; }
        const row = document.createElement('div');
        row.className = 'person';
        row.innerHTML = `
          <input type="text" class="person-name" placeholder="お名前（ニックネーム可）" />
          <select class="person-rel">
            <option value="">関係性を選択</option>
            <option value="family">家族</option>
            <option value="love">恋愛のお相手</option>
            <option value="other">その他の関係</option>
          </select>
        `;
        list.appendChild(row);
        numLabel.textContent = String(current+1);
        recalc();
        // 入力イベント
        const nameInput = row.querySelector('.person-name');
        const relSelect = row.querySelector('.person-rel');
        nameInput.addEventListener('input', ()=>{ if(nameInput.value.trim()===''){ removeError(relSelect); numLabel.textContent = String(countNames(list)); } else { numLabel.textContent = String(countNames(list)); } recalc(); });
        relSelect.addEventListener('change', ()=>{ removeError(relSelect); recalc(); });
      });

      // カード×ボタン
      if(withClear){
        card.querySelector('.floating-clear').addEventListener('click', ()=>{
          card.remove(); recalc();
        });
      }
    }

    function countNames(list){
      return Array.from(list.querySelectorAll('.person-name')).filter(i=> i.value.trim()!=='' ).length;
    }

    function yen(n){
      return `${n.toLocaleString('ja-JP')} 円`;
    }

    function collect(){
      const cards = Array.from(document.querySelectorAll('.consult-card'));
      const consultations = cards.map(card=>{
        const text = card.querySelector('.consult-text').value.trim();
        const persons = [];
        card.querySelectorAll('.person').forEach(p=>{
          const name = p.querySelector('.person-name').value.trim();
          const rel = p.querySelector('.person-rel').value;
          if(name){ persons.push({name, rel}); }
        });
        return { text, persons };
      });
      const couponVal = couponSel.value;
      const couponPct = couponVal==='none' || couponVal==='0' ? 0 : Number(couponVal);
      const pay = paySel.value;
      const note = document.getElementById('note').value.trim();
      return { consultations, couponPct, pay, note };
    }

    function recalc(){
      const data = collect();
      const consultCount = data.consultations.length;
      const additional = Math.max(0, consultCount - 1);
      let subtotal = BASE + additional*ADDITIONAL;
      let relationLines = [];
      let relationTotal = 0;
      data.consultations.forEach(c=>{
        c.persons.forEach(p=>{
          // 無効な関係性は計算に含めない
          if(!p.rel) return;
          const fee = PERSON_FEES[p.rel] || 0;
          relationTotal += fee;
          relationLines.push(`関係者霊視接続料：${p.name}　${fee.toLocaleString('ja-JP')}円`);
        })
      });
      subtotal += relationTotal;
      let optionLines = [];
      if(toggles.handwriting){ subtotal += OPTION_FEES.handwriting; optionLines.push(`筆跡診断${OPTION_FEES.handwriting.toLocaleString('ja-JP')}円`); }
      if(toggles.faceAura){ subtotal += OPTION_FEES.faceAura; optionLines.push(`お顔オーラカラーマップ${OPTION_FEES.faceAura.toLocaleString('ja-JP')}円`); }

      // 割引
      const couponAmt = Math.round(subtotal * (data.couponPct/100));
      const referralAmt = toggles.referral ? 500 : 0;
      const lightAmt = toggles.light ? 5000 : 0;
      const total = Math.max(0, subtotal - couponAmt - referralAmt - lightAmt);

      // 表示テキスト
      const lines = [];
      lines.push('【リーディングお見積り】');
      lines.push('');
      lines.push(`1件：${yen(BASE)}`);
      if(additional>0){ lines.push(`追加相談：${additional}件 × ${ADDITIONAL.toLocaleString('ja-JP')}円 = ${yen(additional*ADDITIONAL)}`); }
      if(relationLines.length){ lines.push(...relationLines); }
      if(optionLines.length){
        lines.push('');
        lines.push('（オプション）');
        lines.push(...optionLines);
      }
      if(toggles.light){ lines.push(''); lines.push('ライト割引-5,000円'); }
      if(toggles.referral){ lines.push('紹介割引-500円'); }
      if(couponAmt>0){ lines.push(`クーポン割引-${couponAmt.toLocaleString('ja-JP')}円`); }

      lines.push('');
      lines.push('--------------------------------');
      lines.push('合計金額：' + yen(total));
      lines.push('--------------------------------');
      lines.push('');
      lines.push('【ご提出いただくもの】');
      lines.push('目元の写真');
      lines.push('手書きのお名前');
      lines.push('手書きの相談のタイトル');

      estimateEl.textContent = lines.join('\n');
    }

    function buildEstimateText(){
      return estimateEl.textContent;
    }

    function validate(){
      let ok = true; let firstErrorEl = null; const errors = [];
      removeAllErrors();
      // 1. ご相談内容（各カードのテキスト必須：最初のカードは必須、追加カードは空のままでも可としますが、あるなら必須）
      const cards = Array.from(document.querySelectorAll('.consult-card'));
      cards.forEach((card, i)=>{
        const ta = card.querySelector('.consult-text');
        const hasPersons = card.querySelectorAll('.person-name').length>0; // 参考
        const val = ta.value.trim();
        if(i===0 && val===''){
          addError(ta); ok=false; firstErrorEl = firstErrorEl || ta; errors.push('ご相談内容（1件目）を入力してください。');
        }
        if(i>0 && val===''){
          // 追加カードは空でもOK。入力がある場合のみチェック
        }
        // 名前があるのに関係性が未選択
        card.querySelectorAll('.person').forEach(p=>{
          const name = p.querySelector('.person-name');
          const rel = p.querySelector('.person-rel');
          if(name.value.trim()!=='' && !rel.value){ addError(rel); ok=false; firstErrorEl = firstErrorEl || rel; }
        });
      });
      // 2. 支払い方法
      if(!paySel.value){ addError(paySel); ok=false; firstErrorEl = firstErrorEl || paySel; errors.push('お支払い方法を選択してください。'); }

      if(!ok){
        alert('必須項目に不備があります。赤枠の項目をご確認ください。');
        if(firstErrorEl){ firstErrorEl.scrollIntoView({behavior:'smooth', block:'center'}); }
      }
      return ok;
    }

    function addError(el){ el.classList.add('error'); }
    function removeError(el){ el.classList.remove('error'); }
    function removeAllErrors(){ document.querySelectorAll('.error').forEach(e=>e.classList.remove('error')); }

    // 入力のたび再計算（フォーム全体へ委譲）
    document.getElementById('form').addEventListener('input', (e)=>{
      if(e.target && (e.target.matches('input, textarea, select'))){ recalc(); }
    });
  })();
  </script>
</body>
</html>
