<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Therapist Mii - リーディングご予約フォーム</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Noto Serif JP -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    <!-- Favicon -->
    <link rel="icon" href="https://github.com/therapist-mii/spiritual/raw/main/images/favicon.png" type="image/png">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'header-bg': '#EAE6E1',
                        'accent-dark': '#776163',
                        'button-normal': '#E4C1B5',
                        'button-hover': '#ad9196',
                        'clear-normal': '#7a736a',
                        'error-red': '#ff0000',
                    },
                    fontFamily: {
                        serif: ['"Noto Serif JP"', 'serif'],
                    }
                }
            }
        }
    </script>
    
    <style>
        /* ベーススタイル設定 */
        body {
            font-family: 'Noto Serif JP', serif;
            background-color: white;
            color: black;
            opacity: 0; /* 初期状態で透明 */
            transition: opacity 1.5s ease-in-out; /* ふわっと表示するトランジション */
        }
        /* ロード後に不透明にする */
        body.loaded {
            opacity: 1;
        }

        /* 必須項目の赤文字 */
        .required-star {
            color: var(--tw-colors-error-red);
            font-weight: bold;
            margin-left: 0.25rem;
        }

        /* フォーム入力時のフォーカススタイル */
        input:focus, textarea:focus, select:focus {
            border-color: #E4C1B5 !important;
            box-shadow: 0 0 0 1px #E4C1B5;
        }

        /* ボタンの共通スタイル */
        .btn-base {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

    </style>
</head>

<body class="loaded">
    <!-- ヘッダー -->
    <header class="bg-header-bg py-4 shadow-md sticky top-0 z-10">
        <div class="max-w-screen-md mx-auto px-4 text-center">
            <h1 class="text-3xl font-bold text-accent-dark">Therapist Mii</h1>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="max-w-screen-md mx-auto p-4 sm:p-6 bg-white">
        <h2 class="text-2xl sm:text-3xl font-bold text-center text-accent-dark mb-8 mt-4">リーディングご予約フォーム</h2>

        <!-- 説明文 -->
        <p class="text-sm mb-6 text-gray-700 p-3 bg-header-bg rounded-lg">
            フォームにご入力後、お見積りが表示されます。「コピー」ボタンを押して内容を確認し、「LINEに貼り付けて予約する」ボタンからご予約ください。
        </p>

        <form id="bookingForm" class="space-y-6">

            <!-- 同意事項 -->
            <div id="agreementSection" class="p-4 border border-gray-300 rounded-lg shadow-inner bg-gray-50/50">
                <label class="block text-lg font-bold mb-3 text-accent-dark">
                    同意事項<span class="required-star">*</span>
                </label>
                <div class="space-y-2 text-sm">
                    <div class="flex items-start">
                        <input type="checkbox" id="policyAgreement" name="agreement" data-name="セッションポリシー、注意事項" class="mt-1 mr-2 appearance-none h-4 w-4 border border-gray-400 rounded-sm bg-white checked:bg-accent-dark checked:border-accent-dark focus:outline-none transition duration-200">
                        <label for="policyAgreement" class="text-gray-700">セッションポリシー、注意事項に同意します。 <a href="https://spiritual-therapist-mii.studio.site/policy" target="_blank" class="text-button-normal hover:text-accent-dark underline">詳細</a></label>
                    </div>
                    <div class="flex items-start">
                        <input type="checkbox" id="notAcceptedAgreement" name="agreement" data-name="お受けできないご相談" class="mt-1 mr-2 appearance-none h-4 w-4 border border-gray-400 rounded-sm bg-white checked:bg-accent-dark checked:border-accent-dark focus:outline-none transition duration-200">
                        <label for="notAcceptedAgreement" class="text-gray-700">お受けできないご相談を確認しました。 <a href="https://spiritual-therapist-mii.studio.site/policy#not-accepted-requests" target="_blank" class="text-button-normal hover:text-accent-dark underline">詳細</a></label>
                    </div>
                    <div class="flex items-start">
                        <input type="checkbox" id="privacyAgreement" name="agreement" data-name="プライバシーポリシー" class="mt-1 mr-2 appearance-none h-4 w-4 border border-gray-400 rounded-sm bg-white checked:bg-accent-dark checked:border-accent-dark focus:outline-none transition duration-200">
                        <label for="privacyAgreement" class="text-gray-700">プライバシーポリシーに同意します。 <a href="https://spiritual-therapist-mii.studio.site/privacypolicy" target="_blank" class="text-button-normal hover:text-accent-dark underline">詳細</a></label>
                    </div>
                </div>
            </div>
            
            <!-- お名前 -->
            <div>
                <label for="clientName" class="block text-lg font-bold mb-1 text-accent-dark">
                    お名前<span class="required-star">*</span>
                </label>
                <input type="text" id="clientName" name="clientName" placeholder="お名前" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-1 focus:ring-button-normal transition duration-150">
            </div>

            <!-- ご相談カテゴリと内容 (繰り返しセクション) -->
            <div id="categoriesContainer" class="space-y-6">
                <!-- 1件目のカテゴリと内容はJavaScriptで追加されます -->
            </div>

            <!-- カテゴリ追加ボタン -->
            <button type="button" id="addCategoryBtn" class="w-full btn-base bg-button-normal text-white hover:bg-button-hover hover:text-white mt-4">
                + 相談カテゴリを追加 (1,000円／1カテゴリ追加)
            </button>
            <p class="text-xs text-gray-500 text-center mt-2">※お受けできないご相談をご確認ください</p>

            <!-- お支払い方法 -->
            <div>
                <label for="paymentMethod" class="block text-lg font-bold mb-1 text-accent-dark">
                    お支払い方法<span class="required-star">*</span>
                </label>
                <select id="paymentMethod" name="paymentMethod" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-1 focus:ring-button-normal transition duration-150 bg-white">
                    <option value="">選択してください</option>
                    <option value="銀行振込">銀行振込</option>
                    <option value="Paypay">Paypay</option>
                    <option value="Paypal">Paypal</option>
                </select>
            </div>

            <!-- ご希望・ご質問 -->
            <div>
                <label for="notes" class="block text-lg font-bold mb-1 text-accent-dark">
                    ご希望・ご質問
                </label>
                <textarea id="notes" name="notes" placeholder="ご希望・ご質問があればご記入ください" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-1 focus:ring-button-normal transition duration-150"></textarea>
            </div>

        </form>
        
        <!-- お見積り表示 -->
        <div id="quotationArea" class="mt-10 p-5 border-2 border-accent-dark/50 rounded-xl bg-header-bg/70 shadow-lg transition duration-300">
            <h3 class="text-xl font-bold text-accent-dark mb-3 border-b border-accent-dark/30 pb-2">【リーディングお見積り】</h3>
            <div class="text-md space-y-1">
                <p>1件：<span class="float-right">18,000 円</span></p>
                <p>カテゴリ追加料：<span id="extraCategoriesDisplay" class="float-right">0 円</span></p>
                <div class="border-t border-gray-400 my-2"></div>
                <p class="text-lg font-bold text-accent-dark">合計金額：<span id="totalAmountDisplay" class="float-right">18,000 円</span></p>
            </div>
        </div>

        <!-- 提出物リスト -->
        <div class="mt-8 p-5 border border-button-normal rounded-xl bg-white shadow-md">
            <h3 class="text-xl font-bold text-accent-dark mb-3 border-b border-accent-dark/30 pb-2">【ご提出いただくもの】</h3>
            <ul class="list-disc list-inside space-y-1 text-gray-700">
                <li>目元の写真</li>
                <li>手書きのお名前</li>
                <li>手書きの相談のタイトル</li>
            </ul>
        </div>

        <!-- LINEで予約する際の手順 -->
        <div class="mt-8 p-4 bg-error-red/10 border border-error-red/30 rounded-lg">
            <h4 class="text-lg font-bold text-error-red mb-2">【LINEで予約する際の手順】</h4>
            <ol class="list-decimal list-inside space-y-1 text-gray-700">
                <li>ご確認いただけましたら、コピーボタンを押してください。</li>
                <li>「LINEに貼り付けて予約する」ボタンを押し、起動したLINEに貼り付けて送信ください。</li>
            </ol>
        </div>

        <!-- ページ下部機能ボタン -->
        <div class="flex flex-col space-y-4 sm:flex-row sm:space-y-0 sm:space-x-4 mt-8">
            <button type="button" id="clearBtn" class="btn-base bg-clear-normal text-white hover:bg-button-normal sm:w-1/3">
                フォームをクリア
            </button>
            <button type="button" id="copyBtn" class="btn-base bg-button-normal text-white hover:bg-button-hover sm:w-1/3">
                コピー
            </button>
            <button type="button" id="lineBtn" class="btn-base bg-button-normal text-white hover:bg-button-hover sm:w-1/3">
                LINEに貼り付けて予約する
            </button>
        </div>

        <!-- カスタムアラート表示領域 -->
        <div id="customAlert" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-error-red text-white p-4 rounded-lg shadow-2xl z-50 transition-all duration-300 opacity-0 pointer-events-none w-11/12 max-w-sm text-center font-bold">
            <!-- メッセージはJSで挿入されます -->
        </div>

    </main>

    <!-- フッター -->
    <footer class="bg-header-bg mt-12 pt-8 pb-4">
        <div class="max-w-screen-md mx-auto px-4">
            
            <!-- 初めての方へセクション -->
            <div class="mb-8 p-4 bg-white rounded-lg shadow-inner border border-gray-200">
                <h3 class="text-xl font-bold text-accent-dark mb-2">はじめての方へ</h3>
                <p class="text-sm text-gray-700 mb-4">
                    はじめての方は、以下のフォームにご記入お願いいたします。<br>
                    リピーター様も未入力の方はご記入お願いいたします。
                </p>
                <a href="https://spiritual-therapist-mii.studio.site/form" target="_blank" class="w-full inline-block text-center btn-base bg-button-normal text-white hover:bg-button-hover hover:text-white">
                    はじめての方のフォーム
                </a>
            </div>

            <!-- ナビゲーションリンク -->
            <nav class="grid grid-cols-2 gap-2 text-sm text-gray-700">
                <a href="https://spiritual-therapist-mii.studio.site/" class="hover:text-accent-dark transition duration-150">HOME</a>
                <a href="https://spiritual-therapist-mii.studio.site/menu" class="hover:text-accent-dark transition duration-150">メニュー一覧</a>
                <a href="https://spiritual-therapist-mii.studio.site/reading" class="hover:text-accent-dark transition duration-150">リーディング</a>
                <a href="https://spiritual-therapist-mii.studio.site/mirai-navi" class="hover:text-accent-dark transition duration-150">未来ナビ</a>
                <a href="https://spiritual-therapist-mii.studio.site/art-therapy" class="hover:text-accent-dark transition duration-150">アートセラピー</a>
                <a href="https://spiritual-therapist-mii.studio.site/color-card" class="hover:text-accent-dark transition duration-150">カラーカード</a>
                <a href="https://spiritual-therapist-mii.studio.site/healing" class="hover:text-accent-dark transition duration-150">ヒーリング</a>
                <a href="https://spiritual-therapist-mii.studio.site/f2f_reading" class="hover:text-accent-dark transition duration-150">対面リーディング</a>
            </nav>

            <p class="text-center text-xs text-gray-500 mt-6">© 2025 by Therapist Mii. All rights reserved.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('bookingForm');
            const categoriesContainer = document.getElementById('categoriesContainer');
            const addCategoryBtn = document.getElementById('addCategoryBtn');
            const clearBtn = document.getElementById('clearBtn');
            const copyBtn = document.getElementById('copyBtn');
            const lineBtn = document.getElementById('lineBtn');
            const totalAmountDisplay = document.getElementById('totalAmountDisplay');
            const extraCategoriesDisplay = document.getElementById('extraCategoriesDisplay');
            const customAlert = document.getElementById('customAlert');
            let categoryCount = 0; // 1から開始してカテゴリをカウント

            // --- UI/UX: ふわっと表示させるための処理 ---
            document.body.classList.add('loaded');

            // --- カテゴリ追加関数 ---
            const addCategory = (isInitial = false) => {
                categoryCount++;
                const categoryIndex = categoryCount;
                const categoryDiv = document.createElement('div');
                categoryDiv.className = `category-item p-4 border border-gray-200 rounded-lg shadow-sm space-y-4 ${!isInitial ? 'mt-6 bg-white' : 'bg-white'}`;
                categoryDiv.setAttribute('data-index', categoryIndex);
                
                categoryDiv.innerHTML = `
                    <h4 class="text-lg font-bold text-accent-dark border-b border-button-normal/50 pb-2">
                        ${categoryIndex}件目
                        ${categoryIndex > 1 ? '<button type="button" class="float-right text-sm text-clear-normal hover:text-error-red transition duration-150 remove-category-btn">削除</button>' : ''}
                    </h4>
                    
                    <!-- ご相談カテゴリ -->
                    <div>
                        <label for="category${categoryIndex}" class="block text-md font-bold mb-1 text-accent-dark">
                            ご相談カテゴリ<span class="required-star">*</span>
                            ${categoryIndex === 1 ? '<span class="text-xs text-gray-500 font-normal ml-2">※お受けできないご相談をご確認ください</span>' : ''}
                        </label>
                        <input type="text" id="category${categoryIndex}" name="category" placeholder="カテゴリ名（例：仕事、長女の子育てについて、おまかせ など）" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-1 focus:ring-button-normal transition duration-150">
                    </div>

                    <!-- ご相談内容 -->
                    <div>
                        <label for="content${categoryIndex}" class="block text-md font-bold mb-1 text-accent-dark">
                            ご相談内容<span class="required-star">*</span>
                        </label>
                        <textarea id="content${categoryIndex}" name="content" placeholder="ご相談内容をお書きください" rows="6" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-1 focus:ring-button-normal transition duration-150"></textarea>
                    </div>
                `;
                categoriesContainer.appendChild(categoryDiv);

                // カテゴリを削除するボタンにイベントリスナーを追加
                if (categoryIndex > 1) {
                    categoryDiv.querySelector('.remove-category-btn').addEventListener('click', () => {
                        categoryDiv.remove();
                        updateQuotation();
                        // 削除後に表示されている番号を振り直す
                        reindexCategories();
                    });
                }
            };

            // カテゴリのインデックスを振り直す
            const reindexCategories = () => {
                const items = categoriesContainer.querySelectorAll('.category-item');
                categoryCount = 0; // カウントをリセット
                items.forEach((item, index) => {
                    const newIndex = index + 1;
                    categoryCount = newIndex; // 正しいカウントを設定
                    item.setAttribute('data-index', newIndex);
                    
                    // タイトル更新
                    item.querySelector('h4').innerHTML = `
                        ${newIndex}件目
                        ${newIndex > 1 ? '<button type="button" class="float-right text-sm text-clear-normal hover:text-error-red transition duration-150 remove-category-btn">削除</button>' : ''}
                    `;
                    
                    // ラベルと入力欄のID/name更新
                    item.querySelector(`[id^="category"]`).id = `category${newIndex}`;
                    item.querySelector(`[for^="category"]`).setAttribute('for', `category${newIndex}`);
                    item.querySelector(`[id^="content"]`).id = `content${newIndex}`;
                    item.querySelector(`[for^="content"]`).setAttribute('for', `content${newIndex}`);

                    // 削除ボタンのリスナー再設定
                    if (newIndex > 1) {
                        item.querySelector('.remove-category-btn').addEventListener('click', () => {
                            item.remove();
                            updateQuotation();
                            reindexCategories(); // 再帰的に再インデックス
                        });
                    }
                });
            };


            // --- 見積もり更新関数 ---
            const updateQuotation = () => {
                const count = categoriesContainer.querySelectorAll('.category-item').length;
                const initialPrice = 18000;
                const extraCategoryPrice = (count > 0 ? count - 1 : 0) * 1000;
                const totalAmount = initialPrice + extraCategoryPrice;

                // 桁区切り処理
                const formatNumber = (num) => num.toLocaleString('ja-JP');

                extraCategoriesDisplay.textContent = `${formatNumber(extraCategoryPrice)} 円`;
                totalAmountDisplay.textContent = `${formatNumber(totalAmount)} 円`;
            };

            // --- カスタムアラート表示関数 ---
            const showAlert = (message) => {
                customAlert.textContent = message;
                customAlert.classList.remove('opacity-0', 'pointer-events-none');
                customAlert.classList.add('opacity-100');
                
                setTimeout(() => {
                    customAlert.classList.remove('opacity-100');
                    customAlert.classList.add('opacity-0', 'pointer-events-none');
                }, 3000);
            };

            // --- バリデーション関数 ---
            const validateForm = () => {
                let isValid = true;
                const errorFields = [];
                const requiredInputs = form.querySelectorAll('input[name="clientName"], select[name="paymentMethod"]');
                const categoryItems = categoriesContainer.querySelectorAll('.category-item');

                // 以前のエラー表示をクリア
                form.querySelectorAll('.border-error-red').forEach(el => el.classList.remove('border-2', 'border-error-red'));

                // 1. 同意事項チェック
                const agreements = document.querySelectorAll('input[name="agreement"]');
                const agreementSection = document.getElementById('agreementSection');
                let allAgreed = true;
                agreements.forEach(checkbox => {
                    if (!checkbox.checked) {
                        allAgreed = false;
                    }
                });
                if (!allAgreed) {
                    agreementSection.classList.add('border-2', 'border-error-red');
                    errorFields.push("同意事項（すべて）");
                    isValid = false;
                }

                // 2. 一般必須入力チェック
                requiredInputs.forEach(input => {
                    if (!input.value.trim() || (input.tagName === 'SELECT' && input.value === "")) {
                        input.classList.add('border-2', 'border-error-red');
                        errorFields.push(input.previousElementSibling.textContent.replace('*', '').trim());
                        isValid = false;
                    }
                });

                // 3. カテゴリ/内容チェック (最低1件は必須)
                if (categoryItems.length === 0) {
                     // このケースはaddCategoryで初期カテゴリを追加しているため発生しないはずだが、念のため
                    errorFields.push("ご相談カテゴリ（最低1件）");
                    isValid = false;
                } else {
                    categoryItems.forEach((item, index) => {
                        const categoryInput = item.querySelector('input[name="category"]');
                        const contentTextarea = item.querySelector('textarea[name="content"]');
                        
                        if (!categoryInput.value.trim()) {
                            categoryInput.classList.add('border-2', 'border-error-red');
                            errorFields.push(`${index + 1}件目 ご相談カテゴリ`);
                            isValid = false;
                        }
                        if (!contentTextarea.value.trim()) {
                            contentTextarea.classList.add('border-2', 'border-error-red');
                            errorFields.push(`${index + 1}件目 ご相談内容`);
                            isValid = false;
                        }
                    });
                }


                if (!isValid) {
                    showAlert("必須項目を全てご入力ください。");
                    return false;
                }
                return true;
            };

            // --- コピー内容生成関数 ---
            const generateCopyText = () => {
                const clientName = document.getElementById('clientName').value.trim();
                const paymentMethod = document.getElementById('paymentMethod').value;
                const notes = document.getElementById('notes').value.trim();
                const categoryItems = categoriesContainer.querySelectorAll('.category-item');
                const totalAmountText = totalAmountDisplay.textContent;

                let categoryDetails = '';
                categoryItems.forEach((item, index) => {
                    const categoryInput = item.querySelector('input[name="category"]').value.trim();
                    const contentTextarea = item.querySelector('textarea[name="content"]').value.trim();
                    categoryDetails += `
${index + 1}件目
【ご相談カテゴリ】${categoryInput}
【ご相談内容】
${contentTextarea}
`;
                });

                let text = `
リーディング希望

【お名前】${clientName}

${categoryDetails.trim()}

【お支払い方法】${paymentMethod}
${notes ? `\n【ご希望・ご質問】\n${notes}\n` : ''}

--------------------------------

【リーディングお見積り】
1件：18,000 円
カテゴリ追加料：1,000円/1件
--------------------------------
合計金額：${totalAmountText}
--------------------------------

【ご提出いただくもの】
目元の写真
手書きのお名前
手書きの相談のタイトル
`;
                return text.trim();
            };

            // --- クリップボードにコピーする関数 ---
            const copyToClipboard = (text) => {
                // document.execCommand('copy')を使用 (iframe制限対応)
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        showAlert("内容をクリップボードにコピーしました！");
                    } else {
                        showAlert("コピーに失敗しました。手動でコピーしてください。");
                    }
                } catch (err) {
                    showAlert("コピーに失敗しました。手動でコピーしてください。");
                }
                document.body.removeChild(textarea);
            };

            // --- イベントリスナー設定 ---
            
            // 初期カテゴリの追加
            addCategory(true);
            updateQuotation(); 

            // カテゴリ追加ボタン
            addCategoryBtn.addEventListener('click', () => {
                addCategory();
                updateQuotation();
            });

            // 見積もり更新 (入力内容の変更時)
            form.addEventListener('input', updateQuotation);

            // クリアボタン
            clearBtn.addEventListener('click', () => {
                form.reset();
                categoriesContainer.innerHTML = ''; // カテゴリを一度リセット
                categoryCount = 0; // カウントもリセット
                addCategory(true); // 1件目カテゴリを再追加
                updateQuotation();
                showAlert("フォーム内容をクリアしました。");
                // エラー表示をクリア
                form.querySelectorAll('.border-error-red').forEach(el => el.classList.remove('border-2', 'border-error-red'));
            });

            // コピーボタン
            copyBtn.addEventListener('click', () => {
                if (validateForm()) {
                    const text = generateCopyText();
                    copyToClipboard(text);
                }
            });

            // LINEボタン
            lineBtn.addEventListener('click', () => {
                if (validateForm()) {
                    const text = generateCopyText();
                    copyToClipboard(text);
                    // LINEアプリ起動（指定URLに遷移）
                    // 適切なURLエンコードはLINE側で処理される前提で、ここでは遷移のみ
                    window.location.href = "https://line.me/ti/p/Kv76GQK_UI";
                }
            });

            // 同意事項のチェックボックスのカスタムスタイル適用
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.style.cursor = 'pointer';
            });
        });
    </script>
</body>
</html>
