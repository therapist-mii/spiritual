<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リーディングお見積り＆ご予約</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="icon" href="https://github.com/therapist-mii/spiritual/raw/main/images/favicon.png" type="image/png">
    <style>
        body {
            font-family: 'Noto Serif JP', serif;
            color: #776163;
            background-color: #F8F6F4;
        }
        /* カスタムカラー */
        .btn-primary { background-color: #E4C1B5; color: #776163; }
        .btn-primary:hover { background-color: #ad9196; color: white; }
        .btn-secondary { background-color: #e4b5b9; color: #776163; }
        .btn-secondary:hover { background-color: #ad9196; color: white; }
        .btn-clear-main { background-color: #EAE6E1; color: #cbb6b6; }
        .btn-clear-main:hover { background-color: #cbb6b6; color: #EAE6E1; }
        .btn-clear-card { background-color: #7a736a; color: #EAE6E1; }
        .btn-clear-card:hover { background-color: #E4C1B5; color: #776163; }
        .required-star { color: #ff0000; }
        .error-border { border-color: #ff0000 !important; }

        /* フェードインアニメーション */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* フォーム要素の共通スタイル */
        .form-input {
            width: 100%;
            border: 1px solid #E4C1B5;
            border-radius: 8px;
            padding: 10px;
            background-color: white;
            transition: border-color 0.3s;
        }
        .form-input:focus {
            outline: none;
            border-color: #ad9196;
            box-shadow: 0 0 0 2px rgba(173, 145, 150, 0.2);
        }
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .form-description {
            font-size: 0.875rem;
            color: #7a736a;
            margin-top: 4px;
            margin-bottom: 12px;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #EAE6E1;
            position: relative;
        }
    </style>
</head>
<body class="bg-[#F8F6F4]">

    <!-- ヘッダー -->
    <header class="py-6 px-4 bg-white/50 backdrop-blur-sm sticky top-0 z-20">
        <div class="container mx-auto text-center">
            <a href="https://spiritual-therapist-mii.studio.site/" class="inline-block">
                <img src="https://github.com/therapist-mii/spiritual/raw/main/images/rogo-250.png" alt="Logo" class="h-12 w-auto">
            </a>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="container mx-auto p-4 md:p-8 max-w-3xl">
        <div class="text-center mb-8 fade-in">
            <h1 class="text-3xl md:text-4xl font-bold text-[#776163] mb-2">リーディングお見積り＆ご予約</h1>
            <p class="text-[#7a736a]">必要事項を記入してください。一番下に見積もりが出ます。</p>
        </div>

        <form id="quoteForm" class="space-y-8">
            
            <!-- 相談内容コンテナ -->
            <div id="consultationsContainer">
                <!-- ここに相談カードが動的に追加されます -->
            </div>

            <!-- 相談を追加ボタン -->
            <div class="text-center fade-in">
                <button type="button" id="addConsultationBtn" class="btn-primary font-bold py-2 px-6 rounded-full transition-all duration-300 transform hover:scale-105">
                    相談を追加
                </button>
            </div>

            <!-- オプション -->
            <div class="card fade-in">
                <h2 class="text-2xl font-bold mb-4">オプション</h2>
                <div class="space-y-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <div>
                            <h3 class="font-bold">筆跡診断</h3>
                            <p class="form-description mb-2 sm:mb-0">文字の癖から思考傾向や内面のブロックを診断します。 6,000円</p>
                        </div>
                        <button type="button" data-option="handwriting" class="option-btn btn-secondary px-4 py-2 rounded-full transition-all duration-300 shrink-0">追加する</button>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <div>
                            <h3 class="font-bold">お顔オーラカラーマップ</h3>
                            <p class="form-description mb-2 sm:mb-0">お顔に現れるエネルギー傾向をカラーマップで可視化します。 4,000円</p>
                        </div>
                        <button type="button" data-option="auraMap" class="option-btn btn-secondary px-4 py-2 rounded-full transition-all duration-300 shrink-0">追加する</button>
                    </div>
                </div>
            </div>

            <!-- お支払いについて -->
            <div class="card fade-in">
                <h2 class="text-2xl font-bold mb-4">お支払いについて</h2>
                <div class="space-y-6">
                    <div>
                        <label for="coupon" class="form-label">割引</label>
                        <p class="form-description">クーポンをお持ちの方は選択してください。</p>
                        <select id="coupon" name="coupon" class="form-input">
                            <option value="0">選択してください</option>
                            <option value="0">クーポン無し</option>
                            <option value="0.05">5％OFFクーポン</option>
                            <option value="0.1">10％OFFクーポン</option>
                            <option value="0.15">15％OFFクーポン</option>
                            <option value="0.2">20％OFFクーポン</option>
                            <option value="0.25">25％OFFクーポン</option>
                            <option value="0.3">30％OFFクーポン</option>
                        </select>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <div>
                            <h3 class="font-bold">紹介割引</h3>
                            <p class="form-description mb-2 sm:mb-0">ご紹介くださった方と紹介された方を対象に割引できます。他クーポン併用可 紹介割引：−500円</p>
                        </div>
                        <button type="button" data-option="referral" class="option-btn btn-secondary px-4 py-2 rounded-full transition-all duration-300">追加する</button>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <div>
                            <h3 class="font-bold">ライト割引</h3>
                            <p class="form-description mb-2 sm:mb-0">A4用紙1枚程度の量の鑑定書のみ...5,000円引き。納品後のLINEは、お気持ちだけいただき、基本的にこちらからのご返信は控えさせていただきます。</p>
                        </div>
                        <button type="button" data-option="light" class="option-btn btn-secondary px-4 py-2 rounded-full transition-all duration-300">追加する</button>
                    </div>
                     <div>
                        <label for="paymentMethod" class="form-label">お支払い方法<span class="required-star">*</span></label>
                        <select id="paymentMethod" name="paymentMethod" class="form-input" required>
                            <option value="">選択してください</option>
                            <option value="銀行振込">銀行振込</option>
                            <option value="Paypay">Paypay</option>
                            <option value="Paypal">Paypal</option>
                            <option value="クレジットカード">クレジットカード</option>
                            <option value="コンビニ払い">コンビニ払い（手数料220円）</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 備考 -->
            <div class="card fade-in">
                 <label for="remarks" class="form-label">備考</label>
                 <p class="form-description">ご希望・ご質問があればご記入ください</p>
                 <textarea id="remarks" name="remarks" class="form-input" rows="4"></textarea>
            </div>
            
            <!-- ご確認事項 -->
            <div class="card fade-in">
                <h2 class="text-2xl font-bold mb-4">ご確認事項</h2>
                <div class="space-y-6 text-sm text-[#7a736a]">
                    <div>
                        <h3 class="font-bold text-[#776163] mb-2">セッションについて</h3>
                        <p><strong>セッション形式：</strong> 遠隔</p>
                        <p><strong>ご予約：</strong> 日にち指定のみ（時間指定不可）</p>
                    </div>
                    <div>
                        <h3 class="font-bold text-[#776163] mb-2">納品日・営業時間</h3>
                        <p><strong>納品日：</strong>セッション日より5営業日</p>
                        <p><strong>営業時間：</strong> 9：00～17：00</p>
                        <p><strong>休日：</strong>土日祝日、他指定日</p>
                    </div>
                    <div>
                        <h3 class="font-bold text-[#776163] mb-2">セッション後の追加料金について</h3>
                        <p>納品後に、追加の相談がある場合、追加料金が発生いたします。</p>
                        <p>ご相談１件：3,000円～</p>
                    </div>
                     <div>
                        <h3 class="font-bold text-[#776163] mb-2">ご提出いただくもの</h3>
                        <ul class="list-disc list-inside space-y-1">
                            <li>目元の写真</li>
                            <li>手書きのお名前</li>
                            <li>手書きの相談のタイトル</li>
                        </ul>
                        <div class="flex flex-wrap gap-4 mt-4">
                            <img src="https://github.com/therapist-mii/spiritual/raw/main/images/memoto.jpg" alt="目元の写真の例" class="w-32 h-32 object-cover rounded-lg">
                            <img src="https://github.com/therapist-mii/spiritual/raw/main/images/tegaki-r.jpg" alt="手書き文字の例" class="w-32 h-32 object-cover rounded-lg">
                        </div>
                    </div>
                </div>
            </div>

            <!-- お見積り結果 -->
            <div id="quoteResultContainer" class="bg-white rounded-lg p-6 shadow-lg border border-[#E4C1B5] fade-in">
                <pre id="quoteResult" class="whitespace-pre-wrap break-words font-sans"></pre>
            </div>

            <!-- ページ下部機能ボタン -->
            <div class="text-center space-y-4 fade-in">
                 <div class="bg-amber-100/50 p-4 rounded-lg">
                    <h3 class="font-bold text-[#776163] mb-2">【LINEで予約する際の手順】</h3>
                    <ol class="text-left text-sm space-y-1 text-[#7a736a]">
                        <li>① お見積り内容にご了承いただけましたら、コピーボタンを押し、お見積り内容をコピーしてください。</li>
                        <li>② 「LINEに貼り付けて予約する」ボタンを押し、起動したLINEに貼り付けて送信ください。</li>
                    </ol>
                </div>

                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button type="button" id="clearFormBtn" class="btn-clear-main font-bold py-3 px-6 rounded-full transition-all duration-300 transform hover:scale-105">フォームをクリア</button>
                    <button type="button" id="copyBtn" class="btn-primary font-bold py-3 px-6 rounded-full transition-all duration-300 transform hover:scale-105">お見積り内容をコピー</button>
                </div>
                 <button type="button" id="lineBtn" class="w-full sm:w-auto btn-primary font-bold py-3 px-8 rounded-full transition-all duration-300 transform hover:scale-105 text-lg flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M16.143 12.335c.315-1.859-1.25-3.374-3.08-3.374-1.296 0-2.43.743-2.973 1.838-.115.23-.27.436-.45.614-.72 1.053-1.018 2.228-1.018 3.424s.298 2.37 1.017 3.424c.18.178.336.384.45.614.544 1.095 1.677 1.838 2.974 1.838 1.83 0 3.396-1.515 3.08-3.374a.482.482 0 0 0-.08-.242c-.004-.012-.007-.024-.01-.037a.482.482 0 0 0-.08-.242c-.004-.012-.007-.024-.01-.036zm-5.757 3.125s-.45-1.83.54-1.83c.99 0 .45 1.83.45 1.83s-.09.54-.495.54-.495-.54-.495-.54zm5.115 0s-.45-1.83.54-1.83c.99 0 .45 1.83.45 1.83s-.09.54-.495.54-.495-.54-.495-.54zM12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm7.153 16.71c-1.33-1.83-3.045-2.92-5.91-2.92h-1.08c-.015 0-.03.015-.045.015-.015 0-.03 0-.045-.015h-1.08c-2.865 0-4.575 1.095-5.91 2.92a.54.54 0 0 1-.9-.63C3.963 13.995 7.743 12 12 12s8.037 1.995 9.048 4.08a.54.54 0 0 1-.9.63z"/></svg>
                    LINEに貼り付けて予約する
                </button>
            </div>
        </form>
    </main>

    <!-- フッター -->
    <footer class="bg-white/30 mt-16 py-12 px-4 text-center">
        <div class="container mx-auto max-w-3xl">
            <!-- はじめての方へ -->
            <div class="bg-white rounded-lg p-6 mb-8 shadow-sm border border-[#EAE6E1]">
                <h2 class="text-xl font-bold mb-2">はじめての方へ</h2>
                <p class="mb-4 text-sm">はじめての方は、以下のフォームにご記入お願いいたします。<br>リピーター様も未入力の方はご記入お願いいたします。</p>
                <a href="https://spiritual-therapist-mii.studio.site/form" class="btn-secondary inline-block font-bold py-2 px-6 rounded-full transition-all duration-300 transform hover:scale-105">
                    はじめての方のフォーム
                </a>
            </div>

            <!-- メニューリンク -->
            <nav class="mb-8">
                <ul class="flex justify-center gap-6">
                    <li><a href="https://spiritual-therapist-mii.studio.site/" class="hover:text-[#ad9196] transition-colors">Home</a></li>
                    <li><a href="https://spiritual-therapist-mii.studio.site/menu" class="hover:text-[#ad9196] transition-colors">メニュー一覧</a></li>
                </ul>
            </nav>

            <!-- ロゴ -->
            <a href="https://spiritual-therapist-mii.studio.site/" class="inline-block">
                <img src="https://github.com/therapist-mii/spiritual/raw/main/images/rogo-250.png" alt="Logo" class="h-16 w-auto mx-auto">
            </a>
        </div>
    </footer>

    <!-- モーダルウィンドウ（アラート用） -->
    <div id="alertModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
            <p id="alertMessage" class="mb-4"></p>
            <button id="closeModalBtn" class="btn-primary py-2 px-6 rounded-full">閉じる</button>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {

    const consultationsContainer = document.getElementById('consultationsContainer');
    const addConsultationBtn = document.getElementById('addConsultationBtn');
    const quoteResult = document.getElementById('quoteResult');
    const form = document.getElementById('quoteForm');
    
    // ボタン類
    const clearFormBtn = document.getElementById('clearFormBtn');
    const copyBtn = document.getElementById('copyBtn');
    const lineBtn = document.getElementById('lineBtn');

    // モーダル
    const alertModal = document.getElementById('alertModal');
    const alertMessage = document.getElementById('alertMessage');
    const closeModalBtn = document.getElementById('closeModalBtn');

    let consultationIdCounter = 0;

    // --- 初期化 ---
    addConsultationCard(false); // 最初のカードを追加（削除ボタンなし）
    calculateQuote();

    // --- イベントリスナー ---
    
    // フォーム全体の変更を監視して再計算
    form.addEventListener('change', calculateQuote);
    form.addEventListener('keyup', calculateQuote);
    form.addEventListener('click', (e) => {
        if (e.target.classList.contains('option-btn') || e.target.classList.contains('remove-person-btn') || e.target.classList.contains('remove-consultation-btn')) {
            calculateQuote();
        }
    });

    // 相談を追加
    addConsultationBtn.addEventListener('click', () => {
        addConsultationCard(true); // 削除ボタンあり
    });

    // オプションボタンのトグル
    document.querySelectorAll('.option-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            btn.classList.toggle('bg-[#ad9196]');
            btn.classList.toggle('text-white');
            btn.classList.toggle('btn-secondary');
            btn.textContent = btn.classList.contains('bg-[#ad9196]') ? '追加済み' : '追加する';
        });
    });

    // ページ下部ボタン
    clearFormBtn.addEventListener('click', resetForm);
    copyBtn.addEventListener('click', () => handleAction('copy'));
    lineBtn.addEventListener('click', () => handleAction('line'));
    
    // モーダルを閉じる
    closeModalBtn.addEventListener('click', () => alertModal.classList.add('hidden'));
    alertModal.addEventListener('click', (e) => {
        if (e.target === alertModal) {
            alertModal.classList.add('hidden');
        }
    });

    // --- 関数 ---

    function addConsultationCard(canRemove) {
        consultationIdCounter++;
        const cardId = `consultation-${consultationIdCounter}`;
        const card = document.createElement('div');
        card.className = 'card fade-in consultation-card';
        card.id = cardId;
        card.innerHTML = `
            ${canRemove ? `<button type="button" class="remove-consultation-btn btn-clear-card absolute top-3 right-3 h-8 w-8 rounded-full flex items-center justify-center font-bold text-lg transition-colors duration-300" title="この相談を削除">×</button>` : ''}
            <div>
                <label class="form-label">ご相談内容 ${consultationIdCounter}<span class="required-star">*</span></label>
                <p class="form-description">相談内容の要点のみご記入ください。詳細はLINEにてお知らせください。</p>
                <textarea class="form-input consultation-text" rows="4" placeholder="例：守護霊様からのメッセージをお願いします" required></textarea>
            </div>
            <div class="mt-6">
                <label class="form-label">ご相談内容に関係する方 <span class="text-sm font-normal">(<span class="person-count">0</span>/5名)</span></label>
                <p class="form-description">人間関係のご相談など、鑑定結果に言及する必要のある方のお名前（ニックネーム可）。最大5名まで</p>
                <div class="related-people-container space-y-4">
                    <!-- 関係者入力欄がここに追加されます -->
                </div>
                <button type="button" class="add-person-btn mt-4 btn-secondary text-sm py-2 px-4 rounded-full transition-all duration-300">関係者を追加</button>
            </div>
        `;
        consultationsContainer.appendChild(card);
        
        // 新しく追加したカード内のイベントリスナーを設定
        const newCard = document.getElementById(cardId);
        newCard.querySelector('.add-person-btn').addEventListener('click', (e) => {
            const container = newCard.querySelector('.related-people-container');
            if (container.children.length < 5) {
                addRelatedPerson(container);
                updatePersonCount(newCard);
            } else {
                showAlert('関係者は最大5名までです。');
            }
        });

        if (canRemove) {
            newCard.querySelector('.remove-consultation-btn').addEventListener('click', () => {
                newCard.remove();
                calculateQuote();
            });
        }
    }

    function addRelatedPerson(container) {
        const personDiv = document.createElement('div');
        personDiv.className = 'flex items-center gap-2 related-person-row fade-in';
        personDiv.innerHTML = `
            <div class="flex-1">
                <input type="text" class="form-input person-name" placeholder="お名前 (ニックネーム可)">
            </div>
            <div class="flex-1">
                <select class="form-input person-relationship">
                    <option value="">関係性を選択</option>
                    <option value="family">家族</option>
                    <option value="partner">恋愛のお相手</option>
                    <option value="other">その他の関係</option>
                </select>
            </div>
            <button type="button" class="remove-person-btn btn-clear-card h-8 w-8 rounded-full flex items-center justify-center font-bold shrink-0 transition-colors duration-300" title="この人を削除">×</button>
        `;
        container.appendChild(personDiv);

        personDiv.querySelector('.remove-person-btn').addEventListener('click', () => {
            const card = container.closest('.consultation-card');
            personDiv.remove();
            updatePersonCount(card);
            calculateQuote();
        });
        
        personDiv.querySelector('.person-name').addEventListener('keyup', () => {
            const relationshipSelect = personDiv.querySelector('.person-relationship');
            if (personDiv.querySelector('.person-name').value.trim() !== '') {
                relationshipSelect.setAttribute('required', 'true');
            } else {
                relationshipSelect.removeAttribute('required');
            }
        });
    }

    function updatePersonCount(card) {
        const container = card.querySelector('.related-people-container');
        const count = container.children.length;
        card.querySelector('.person-count').textContent = count;
    }

    function calculateQuote() {
        let total = 0;
        let quoteText = "【リーディングお見積り】\n\n";

        // 基本料金・追加相談料
        const consultationCards = document.querySelectorAll('.consultation-card');
        if (consultationCards.length > 0) {
            total += 16000;
            quoteText += `1件：16,000 円\n`;
        }
        if (consultationCards.length > 1) {
            const additionalConsultations = consultationCards.length - 1;
            total += additionalConsultations * 3000;
            quoteText += `追加相談料 ${additionalConsultations}件：${(additionalConsultations * 3000).toLocaleString()} 円\n`;
        }
        
        // 関係者霊視接続料
        let hasRelatedPeople = false;
        let peopleDetails = "関係者霊視接続料：\n";
        consultationCards.forEach(card => {
            card.querySelectorAll('.related-person-row').forEach(row => {
                const name = row.querySelector('.person-name').value.trim();
                const relationship = row.querySelector('.person-relationship').value;
                if (name && relationship) {
                    hasRelatedPeople = true;
                    let cost = 0;
                    let type = '';
                    switch (relationship) {
                        case 'family': cost = 1500; type = '家族'; break;
                        case 'partner': cost = 5000; type = '恋愛のお相手'; break;
                        case 'other': cost = 3000; type = 'その他'; break;
                    }
                    total += cost;
                    peopleDetails += `  ${name} 様 (${type})：${cost.toLocaleString()} 円\n`;
                }
            });
        });
        if (hasRelatedPeople) {
            quoteText += `\n${peopleDetails}`;
        }

        // オプション
        let hasOptions = false;
        let optionDetails = "（オプション）\n";
        const handwritingBtn = document.querySelector('[data-option="handwriting"]');
        if (handwritingBtn.classList.contains('bg-[#ad9196]')) {
            total += 6000;
            optionDetails += "  筆跡診断：6,000 円\n";
            hasOptions = true;
        }
        const auraMapBtn = document.querySelector('[data-option="auraMap"]');
        if (auraMapBtn.classList.contains('bg-[#ad9196]')) {
            total += 4000;
            optionDetails += "  お顔オーラカラーマップ：4,000 円\n";
            hasOptions = true;
        }
        if (hasOptions) {
            quoteText += `\n${optionDetails}`;
        }
        
        let subtotal = total;

        // 割引
        let hasDiscounts = false;
        let discountDetails = "";
        const lightBtn = document.querySelector('[data-option="light"]');
        if (lightBtn.classList.contains('bg-[#ad9196]')) {
            total -= 5000;
            discountDetails += "ライト割引：-5,000 円\n";
            hasDiscounts = true;
        }
        const referralBtn = document.querySelector('[data-option="referral"]');
        if (referralBtn.classList.contains('bg-[#ad9196]')) {
            total -= 500;
            discountDetails += "紹介割引：-500 円\n";
            hasDiscounts = true;
        }
        const couponRate = parseFloat(document.getElementById('coupon').value);
        if (couponRate > 0) {
            const couponDiscount = Math.floor(subtotal * couponRate);
            total -= couponDiscount;
            discountDetails += `クーポン割引 (${couponRate * 100}％)：-${couponDiscount.toLocaleString()} 円\n`;
            hasDiscounts = true;
        }
        
        if (hasDiscounts) {
            quoteText += `\n${discountDetails}`;
        }

        // 手数料
        const paymentMethod = document.getElementById('paymentMethod').value;
        if(paymentMethod === 'コンビニ払い') {
            total += 220;
            quoteText += "\nコンビニ払い手数料：220円\n";
        }


        quoteText += "\n--------------------------------\n";
        quoteText += `合計金額：${Math.max(0, total).toLocaleString()} 円`;
        quoteText += "\n--------------------------------\n";
        
        quoteText += `\n【ご提出いただくもの】
・目元の写真
・手書きのお名前
・手書きの相談のタイトル`;

        quoteResult.textContent = quoteText;
    }

    function validateForm() {
        clearErrors();
        let isValid = true;
        const requiredFields = form.querySelectorAll('[required]');

        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                isValid = false;
                field.classList.add('error-border');
            }
        });
        
        // 関係者名が入力されている場合、関係性の選択も必須
        form.querySelectorAll('.related-person-row').forEach(row => {
            const nameInput = row.querySelector('.person-name');
            const relationshipSelect = row.querySelector('.person-relationship');
            if (nameInput.value.trim() && !relationshipSelect.value) {
                isValid = false;
                relationshipSelect.classList.add('error-border');
            }
        });


        if (!isValid) {
            showAlert('必須項目(*)をすべて入力してください。');
        }
        
        return isValid;
    }
    
    function handleAction(type) {
        if (validateForm()) {
            const quoteText = quoteResult.textContent;
            if (type === 'copy') {
                copyToClipboard(quoteText);
            } else if (type === 'line') {
                window.open('https://line.me/ti/p/Kv76GQK_UI', '_blank');
            }
        }
    }
    
    function copyToClipboard(text) {
        // execCommandは非推奨だが、iframe環境での互換性のために残す
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            showAlert('お見積り内容をコピーしました！');
        } catch (err) {
            showAlert('コピーに失敗しました。');
        }
        document.body.removeChild(textArea);
    }
    
    function resetForm() {
        form.reset();
        consultationsContainer.innerHTML = '';
        addConsultationCard(false); // 最初のカードを再追加
        document.querySelectorAll('.option-btn').forEach(btn => {
            btn.classList.remove('bg-[#ad9196]', 'text-white');
            btn.classList.add('btn-secondary');
            btn.textContent = '追加する';
        });
        clearErrors();
        calculateQuote();
    }
    
    function clearErrors() {
        form.querySelectorAll('.error-border').forEach(el => el.classList.remove('error-border'));
    }

    function showAlert(message) {
        alertMessage.textContent = message;
        alertModal.classList.remove('hidden');
    }

});
</script>

</body>
</html>
