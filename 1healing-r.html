<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1分ヒーリングお見積り＆ご予約</title>
    <link rel="icon" type="image/png" href="https://github.com/therapist-mii/spiritual/raw/main/images/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        error: '#ff0000',
                        button: {
                            normal: '#E4C1B5',
                            hover: '#ad9196',
                            text: '#fff',
                        },
                        firstTimeButton: {
                            normal: '#e4b5b9',
                            hover: '#ad9196',
                            text: '#fff',
                        },
                        clearButton: {
                            normal: '#7a736a',
                            hover: '#E4C1B5',
                            text: '#fff',
                        },
                        clearText: {
                            normal: '#EAE6E1',
                            hover: '#cbb6b6',
                        },
                        bodyText: '#776163',
                        background: '#F5F2F0',
                    },
                    fontFamily: {
                        'noto-serif-jp': ['"Noto Serif JP"', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Noto Serif JP', serif;
            color: #776163;
            background-color: #F5F2F0;
            overflow-x: hidden;
            animation: fadeIn 1s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
            transition: all 0.3s ease-in-out;
            background-color: #fff;
            color: #776163;
            outline: none;
        }

        .form-input:focus {
            border-color: #ad9196;
            box-shadow: 0 0 0 2px rgba(173, 145, 150, 0.2);
        }

        .form-input:hover {
            border-color: #ad9196;
        }

        .required-label::after {
            content: '*';
            color: #ff0000;
            margin-left: 0.25rem;
        }

        .error-border {
            border-color: #ff0000 !important;
        }
        
        .calendar-error-border {
            border: 1px solid #ff0000;
            border-radius: 0.5rem;
            padding: 0.5rem;
            transition: all 0.3s ease-in-out;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            max-width: 90%;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .fade-in {
            animation: fadeIn 1s ease-in-out forwards;
        }

        .slide-up {
            animation: slideUp 0.8s ease-out forwards;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .calendar-nav-btn {
            padding: 0.25rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }

        .calendar-nav-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .calendar-date-cell {
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }

        .calendar-date-cell:hover:not(.disabled) {
            background-color: #ad9196;
            color: #fff;
        }

        .calendar-date-cell.selected {
            background-color: #e4b5b9;
            color: white;
        }

        .calendar-date-cell.disabled {
            color: #ccc;
            cursor: not-allowed;
            background-color: #f7f7f7;
        }
    </style>
</head>

<body class="font-noto-serif-jp min-h-screen">
    <div class="container mx-auto p-4 max-w-2xl">

        <!-- Header -->
        <header class="text-center py-8">
            <a href="https://spiritual-therapist-mii.studio.site/" class="inline-block">
                <img src="https://github.com/therapist-mii/spiritual/raw/main/images/rogo-250.png" alt="Miiロゴ" class="max-w-full h-auto">
            </a>
        </header>

        <!-- Main Content -->
        <main class="bg-white p-6 rounded-3xl shadow-lg border-2 border-button-normal mb-8 slide-up">
            <h1 class="text-xl md:text-2xl font-bold text-center mb-6">1分ヒーリングお見積り＆ご予約</h1>
            <form id="healingForm" class="space-y-6">

                <!-- ご予約時間 -->
                <div>
                    <label for="minutes" class="required-label block mb-2 font-semibold">ご予約時間</label>
                    <p class="text-sm text-gray-500 mb-2">基本料金: 1分 200円</p>
                    <select id="minutes" name="minutes" class="form-input">
                        <option value="">選択してください</option>
                        <option value="1">1分</option>
                        <option value="2">2分</option>
                        <option value="3">3分</option>
                        <option value="4">4分</option>
                        <option value="5">5分</option>
                        <option value="10">10分</option>
                    </select>
                </div>

                <!-- ご希望日 -->
                <div id="date-selection-container">
                    <label class="required-label block mb-2 font-semibold">ご希望日</label>
                    <p class="text-xs mb-2 text-gray-500">短時間を複数回おこなうことで効果が出やすくなります。複数日ご利用になるか、３０分のヒーリングと併用をおすすめいたします。</p>
                    <div class="flex items-center mb-4">
                        <span id="prevMonth" class="calendar-nav-btn cursor-pointer mr-2">＜</span>
                        <div id="calendarMonthLabel" class="flex-1 text-center font-bold"></div>
                        <span id="nextMonth" class="calendar-nav-btn cursor-pointer ml-2">＞</span>
                    </div>
                    <div id="calendar" class="grid grid-cols-7 gap-1 text-center"></div>
                    <p class="text-xs mt-2 text-gray-500">※日にちを複数選択できます</p>
                </div>

                <!-- 当サロンご利用回数 -->
                <div>
                    <label for="customerType" class="required-label block mb-2 font-semibold">当サロンご利用回数</label>
                    <select id="customerType" name="customerType" class="form-input">
                        <option value="">選択してください</option>
                        <option value="はじめて">はじめて</option>
                        <option value="２回以上">２回以上</option>
                    </select>
                </div>

                <!-- 割引（クーポン） -->
                <div>
                    <label for="coupon" class="block mb-2 font-semibold">割引（クーポン）</label>
                    <select id="coupon" name="coupon" class="form-input">
                        <option value="0">クーポン無し</option>
                        <option value="5">5％OFF</option>
                        <option value="10">10％OFF</option>
                        <option value="15">15％OFF</option>
                        <option value="20">20％OFF</option>
                        <option value="25">25％OFF</option>
                        <option value="30">30％OFF</option>
                    </select>
                </div>

                <!-- お支払い方法 -->
                <div>
                    <label for="paymentMethod" class="required-label block mb-2 font-semibold">お支払い方法</label>
                    <select id="paymentMethod" name="paymentMethod" class="form-input">
                        <option value="">選択してください</option>
                        <option value="銀行振込">銀行振込</option>
                        <option value="Paypay">Paypay</option>
                        <option value="Paypal">Paypal</option>
                        <option value="クレジットカード">クレジットカード</option>
                        <option value="コンビニ払い">コンビニ払い</option>
                    </select>
                    <p class="text-xs mt-1 text-gray-500">※コンビニ払い手数料220円はお支払い金額に加算されません。</p>
                </div>

                <!-- 備考 -->
                <div>
                    <label for="notes" class="block mb-2 font-semibold">備考（任意）</label>
                    <textarea id="notes" name="notes" rows="4" class="form-input"></textarea>
                </div>

                <!-- 確認事項 -->
                <div class="bg-gray-100 p-4 rounded-xl text-sm border border-gray-300">
                    <p class="font-bold mb-2">【ご確認事項】</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li>セッション形式： 遠隔</li>
                        <li>ご予約： 日にち指定のみ（時間指定不可）</li>
                        <li>納品日：セッション日より5営業日</li>
                        <li>営業時間： 9：00～17：00</li>
                        <li>休日：土日祝日、他指定日</li>
                    </ul>
                </div>

                <!-- ご提出いただくもの -->
                <div id="hajimeteMaterials" class="mt-8 transition-all duration-500 ease-in-out" style="max-height: 0; opacity: 0; overflow: hidden;">
                    <p class="font-bold mb-4">【ご提出いただくもの】</p>
                    <div class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0 md:space-x-4">
                        <div class="flex-1 text-center">
                            <img src="https://github.com/therapist-mii/spiritual/raw/main/images/memoto.jpg" alt="目元の写真" class="w-full h-auto rounded-lg mb-2 mx-auto max-w-[200px]">
                            <p class="text-sm">目元の写真</p>
                        </div>
                        <div class="flex-1 text-center">
                            <img src="https://github.com/therapist-mii/spiritual/raw/main/images/name.jpg" alt="手書きのお名前" class="w-full h-auto rounded-lg mb-2 mx-auto max-w-[200px]">
                            <p class="text-sm">手書きのお名前</p>
                        </div>
                    </div>
                </div>

            </form>

            <!-- お見積り出力 -->
            <div id="estimateOutput" class="bg-gray-100 p-6 rounded-xl border-2 border-gray-300 mt-8 transition-all duration-500 ease-in-out transform scale-95 opacity-0">
            </div>

            <!-- ボタンエリア -->
            <div class="mt-8 space-y-4">
                <p class="text-sm">
                    <span class="font-bold">【LINEで予約する際の手順】</span><br>
                    ① お見積り内容にご了承いただけましたら、コピーボタンを押し、お見積り内容をコピーしてください。<br>
                    ② 「LINEに貼り付けて予約する」ボタンを押し、起動したLINEに貼り付けて送信ください。
                </p>
                <div class="flex flex-col md:flex-row md:space-x-4 space-y-4 md:space-y-0">
                    <button id="clearBtn" class="flex-1 rounded-full py-3 px-6 font-bold text-clearButton-text transition-all duration-300 bg-clearButton-normal hover:bg-clearButton-hover">
                        <span class="text-clearText-normal hover:text-clearText-hover transition-colors duration-300">×</span> クリア
                    </button>
                    <button id="copyBtn" class="flex-1 rounded-full py-3 px-6 font-bold text-button-text transition-all duration-300 bg-button-normal hover:bg-button-hover">コピー</button>
                    <button id="lineBtn" class="flex-1 rounded-full py-3 px-6 font-bold text-button-text transition-all duration-300 bg-firstTimeButton-normal hover:bg-firstTimeButton-hover">LINEに貼り付けて予約する</button>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="text-center py-8">
            <h2 class="font-bold text-xl md:text-2xl mb-4">はじめての方へ</h2>
            <p class="mb-4">
                はじめての方は、以下のフォームにご記入お願いいたします。<br>
                リピーター様も未入力の方はご記入お願いいたします。
            </p>
            <a href="https://spiritual-therapist-mii.studio.site/form" class="inline-block rounded-full py-3 px-8 font-bold text-firstTimeButton-text transition-all duration-300 bg-firstTimeButton-normal hover:bg-firstTimeButton-hover mb-8">はじめての方のフォーム</a>

            <div class="flex justify-center space-x-6 mb-8">
                <a href="https://spiritual-therapist-mii.studio.site/" class="text-sm text-bodyText hover:text-ad9196 transition-colors duration-200">Home</a>
                <a href="https://spiritual-therapist-mii.studio.site/menu" class="text-sm text-bodyText hover:text-ad9196 transition-colors duration-200">メニュー一覧</a>
            </div>

            <a href="https://spiritual-therapist-mii.studio.site/" class="inline-block">
                <img src="https://github.com/therapist-mii/spiritual/raw/main/images/rogo-250.png" alt="Miiロゴ" class="w-auto h-32 md:h-40 mx-auto opacity-50">
            </a>
        </footer>

    </div>

    <!-- Modal for validation errors -->
    <div id="validationModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold text-error mb-4">入力エラー</h3>
            <p id="modalMessage" class="text-bodyText mb-4">必須項目をすべて入力してください。</p>
            <button id="modalCloseBtn" class="rounded-full py-2 px-6 bg-button-normal text-button-text hover:bg-button-hover transition-colors duration-300">閉じる</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('healingForm');
            const minutesSelect = document.getElementById('minutes');
            const customerTypeSelect = document.getElementById('customerType');
            const couponSelect = document.getElementById('coupon');
            const paymentMethodSelect = document.getElementById('paymentMethod');
            const hajimeteMaterials = document.getElementById('hajimeteMaterials');
            const estimateOutput = document.getElementById('estimateOutput');
            const clearBtn = document.getElementById('clearBtn');
            const copyBtn = document.getElementById('copyBtn');
            const lineBtn = document.getElementById('lineBtn');
            const validationModal = document.getElementById('validationModal');
            const modalMessage = document.getElementById('modalMessage');
            const modalCloseBtn = document.getElementById('modalCloseBtn');
            const calendar = document.getElementById('calendar');
            const prevMonthBtn = document.getElementById('prevMonth');
            const nextMonthBtn = document.getElementById('nextMonth');
            const calendarMonthLabel = document.getElementById('calendarMonthLabel');
            const dateSelectionContainer = document.getElementById('date-selection-container');

            let selectedDates = [];
            let currentMonth = new Date();

            const requiredFields = [minutesSelect, paymentMethodSelect, customerTypeSelect];

            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('ja-JP', {
                    style: 'currency',
                    currency: 'JPY'
                }).format(amount);
            };

            const updateEstimate = () => {
                const minutes = parseInt(minutesSelect.value) || 0;
                const couponPercentage = parseInt(couponSelect.value) || 0;
                const datesCount = selectedDates.length;
                const paymentMethod = paymentMethodSelect.value;
                const customerType = customerTypeSelect.value;

                if (minutes === 0 || datesCount === 0 || paymentMethod === "" || customerType === "") {
                    estimateOutput.innerHTML = '';
                    estimateOutput.classList.remove('scale-100', 'opacity-100');
                    estimateOutput.classList.add('scale-95', 'opacity-0');
                    return;
                }

                const basePricePerSession = minutes * 200;
                const totalBasePrice = basePricePerSession * datesCount;
                const discountAmount = Math.floor(totalBasePrice * (couponPercentage / 100));
                const finalPrice = totalBasePrice - discountAmount;

                const hasMaterials = customerType === "はじめて";
                
                const outputHTML = `
                    <h3 class="font-bold text-lg mb-4">【1分ヒーリングお見積り】</h3>
                    <div class="space-y-2">
                        <p>${datesCount}回　${minutes}分：${formatCurrency(basePricePerSession)}</p>
                        <p>合計 ${datesCount}回</p>
                        <p>ご希望日：<br>${selectedDates.map(d => `${d.getFullYear()}年${d.getMonth() + 1}月${d.getDate()}日(${['日', '月', '火', '水', '木', '金', '土'][d.getDay()]})`).join('<br>')}</p>
                        <hr class="my-4 border-gray-400">
                        <p>合計 ${formatCurrency(totalBasePrice)}</p>
                        <p>割引（クーポン）：-${formatCurrency(discountAmount)}</p>
                        <p>お支払い方法：${paymentMethod}</p>
                        <hr class="my-4 border-gray-400">
                        <p class="text-xl font-bold">合計金額：${formatCurrency(finalPrice)}</p>
                        <hr class="my-4 border-gray-400">
                    </div>
                    ${hasMaterials ? `
                    <h3 class="font-bold text-lg mt-4">【ご提出いただくもの】</h3>
                    <p class="text-sm mt-2">目元の写真</p>
                    <p class="text-sm">手書きのお名前</p>
                    ` : ''}
                `;

                estimateOutput.innerHTML = outputHTML;
                estimateOutput.classList.remove('scale-95', 'opacity-0');
                estimateOutput.classList.add('scale-100', 'opacity-100');
            };

            const toggleHajimeteMaterials = () => {
                const isFirstTime = customerTypeSelect.value === "はじめて";
                if (isFirstTime) {
                    hajimeteMaterials.style.maxHeight = hajimeteMaterials.scrollHeight + 'px';
                    hajimeteMaterials.style.opacity = 1;
                } else {
                    hajimeteMaterials.style.maxHeight = 0;
                    hajimeteMaterials.style.opacity = 0;
                }
            };

            const validateForm = () => {
                let isValid = true;
                requiredFields.forEach(field => {
                    if (field.value.trim() === '') {
                        field.classList.add('error-border');
                        isValid = false;
                    } else {
                        field.classList.remove('error-border');
                    }
                });

                if (selectedDates.length === 0) {
                    dateSelectionContainer.classList.add('calendar-error-border');
                    isValid = false;
                } else {
                    dateSelectionContainer.classList.remove('calendar-error-border');
                }

                return isValid;
            };

            const showModal = (message) => {
                modalMessage.textContent = message;
                validationModal.style.display = 'flex';
            };

            const hideModal = () => {
                validationModal.style.display = 'none';
            };

            const generateCalendar = (date) => {
                calendar.innerHTML = '';
                const year = date.getFullYear();
                const month = date.getMonth();

                calendarMonthLabel.textContent = `${year}年${month + 1}月`;

                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const today = new Date();

                const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
                dayNames.forEach(dayName => {
                    const dayCell = document.createElement('div');
                    dayCell.textContent = dayName;
                    dayCell.className = 'font-bold text-sm text-gray-500';
                    calendar.appendChild(dayCell);
                });

                for (let i = 0; i < firstDay.getDay(); i++) {
                    const emptyCell = document.createElement('div');
                    calendar.appendChild(emptyCell);
                }

                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const dateObj = new Date(year, month, day);
                    const cell = document.createElement('div');
                    cell.textContent = day;
                    cell.className = 'calendar-date-cell';

                    const isPastDay = dateObj < new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    const isSelected = selectedDates.some(d => d.getTime() === dateObj.getTime());

                    if (isPastDay) {
                        cell.classList.add('disabled');
                    } else {
                        cell.classList.add('cursor-pointer');
                        cell.addEventListener('click', () => {
                            if (cell.classList.contains('selected')) {
                                selectedDates = selectedDates.filter(d => d.getTime() !== dateObj.getTime());
                                cell.classList.remove('selected');
                            } else {
                                selectedDates.push(dateObj);
                                cell.classList.add('selected');
                            }
                            selectedDates.sort((a, b) => a - b);
                            updateEstimate();
                        });
                    }

                    if (isSelected) {
                        cell.classList.add('selected');
                    }

                    calendar.appendChild(cell);
                }
            };

            const handleMonthChange = (direction) => {
                const newDate = new Date(currentMonth);
                newDate.setMonth(currentMonth.getMonth() + direction);
                const today = new Date();
                const diffMonths = (newDate.getFullYear() - today.getFullYear()) * 12 + (newDate.getMonth() - today.getMonth());

                if (diffMonths >= 0 && diffMonths < 2) {
                    currentMonth = newDate;
                    generateCalendar(currentMonth);
                }
            };
            
            prevMonthBtn.addEventListener('click', () => handleMonthChange(-1));
            nextMonthBtn.addEventListener('click', () => handleMonthChange(1));

            minutesSelect.addEventListener('change', updateEstimate);
            customerTypeSelect.addEventListener('change', () => {
                toggleHajimeteMaterials();
                updateEstimate();
            });
            couponSelect.addEventListener('change', updateEstimate);
            paymentMethodSelect.addEventListener('change', updateEstimate);

            clearBtn.addEventListener('click', () => {
                form.reset();
                selectedDates = [];
                currentMonth = new Date();
                generateCalendar(currentMonth);
                requiredFields.forEach(field => field.classList.remove('error-border'));
                dateSelectionContainer.classList.remove('calendar-error-border');
                estimateOutput.innerHTML = '';
                estimateOutput.classList.add('scale-95', 'opacity-0');
                toggleHajimeteMaterials();
            });

            copyBtn.addEventListener('click', () => {
                if (validateForm()) {
                    const estimateText = estimateOutput.innerText;
                    if (estimateText) {
                        const textarea = document.createElement('textarea');
                        textarea.value = estimateText;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        
                        // Visual feedback
                        const originalText = copyBtn.textContent;
                        copyBtn.textContent = 'コピーしました！';
                        copyBtn.classList.remove('bg-button-normal', 'hover:bg-button-hover');
                        copyBtn.classList.add('bg-green-500');
                        copyBtn.disabled = true;

                        setTimeout(() => {
                            copyBtn.textContent = originalText;
                            copyBtn.classList.add('bg-button-normal', 'hover:bg-button-hover');
                            copyBtn.classList.remove('bg-green-500');
                            copyBtn.disabled = false;
                        }, 2000);
                    } else {
                        showModal('お見積りを作成するために、必須項目をすべて入力してください。');
                    }
                } else {
                    showModal('必須項目をすべて入力してください。');
                }
            });

            lineBtn.addEventListener('click', () => {
                if (validateForm()) {
                    window.location.href = 'https://line.me/ti/p/Kv76GQK_UI';
                } else {
                    showModal('必須項目をすべて入力してください。');
                }
            });

            modalCloseBtn.addEventListener('click', hideModal);

            // Initial setup
            generateCalendar(currentMonth);
            updateEstimate();
        });
    </script>
</body>

</html>
