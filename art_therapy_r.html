<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アートセラピーお見積り＆ご予約</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" href="https://github.com/therapist-mii/spiritual/raw/main/images/favicon.png" type="image/png">
    <style>
        /* カスタムスタイル */
        body {
            font-family: 'Noto Serif JP', serif;
            color: #776163;
            background-color: #FDFCFB; /* 背景色を少し柔らかく */
        }

        /* 必須項目のアスタリスク */
        .required-star::after {
            content: ' *';
            color: #ff0000;
        }
        
        /* カスタムボタンのスタイル */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px; /* pill shape */
            font-weight: 500;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            cursor: pointer;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-primary { background-color: #E4C1B5; color: white; }
        .btn-primary:hover { background-color: #ad9196; }
        
        .btn-secondary { background-color: #e4b5b9; color: white; }
        .btn-secondary:hover { background-color: #ad9196; }

        .btn-clear-wrapper { background-color: #7a736a; color: #EAE6E1; }
        .btn-clear-wrapper:hover { background-color: #E4C1B5; }
        .btn-clear-wrapper:hover .btn-clear-text { color: #cbb6b6; }

        /* 入力フォームのスタイル */
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #EAE6E1;
            border-radius: 0.5rem;
            background-color: #FFFFFF;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #E4C1B5;
            box-shadow: 0 0 0 2px rgba(228, 193, 181, 0.5);
        }
        .form-input.error, .form-select.error, .form-textarea.error {
            border-color: #ff0000;
            box-shadow: 0 0 0 2px rgba(255, 0, 0, 0.3);
        }

        /* アニメーション */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }

        /* カードデザイン */
        .content-card {
            background-color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #EAE6E1;
            position: relative;
        }
    </style>
</head>
<body class="antialiased">

    <!-- ヘッダー -->
    <header class="py-6 px-4 flex justify-center items-center flex-col">
        <a href="https://spiritual-therapist-mii.studio.site/" target="_blank" rel="noopener noreferrer">
            <img src="https://github.com/therapist-mii/spiritual/raw/main/images/rogo-250.png" alt="ロゴ" class="w-48 h-auto">
        </a>
        <h1 class="text-2xl md:text-3xl font-bold mt-4 text-center">アートセラピーお見積り＆ご予約</h1>
    </header>

    <!-- メインコンテンツ -->
    <main class="max-w-3xl mx-auto px-4 pb-16">
        <div class="text-center mb-8">
            <p>必要事項を記入してください。</p>
            <p>一番下に見積もりが出ます。</p>
        </div>

        <!-- エラーメッセージ表示エリア -->
        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6 text-center" role="alert">
            <strong class="font-bold">必須項目を入力してください。</strong>
        </div>

        <form id="estimate-form">
            <!-- 相談カードが挿入されるコンテナ -->
            <div id="consultation-cards-container"></div>
            
            <div class="flex justify-center my-6">
                <button type="button" id="add-consultation-btn" class="btn btn-primary">深掘りしたいことを追加</button>
            </div>
            
            <!-- 割引 -->
            <div class="content-card fade-in">
                <h2 class="text-xl font-semibold mb-4 text-center">割引</h2>
                <div class="space-y-4">
                    <div>
                        <label for="coupon" class="block mb-2 font-medium">クーポン</label>
                        <select id="coupon" name="coupon" class="form-select">
                            <option value="0">選択してください</option>
                            <option value="0">クーポン無し</option>
                            <option value="0.05">5％OFFクーポン</option>
                            <option value="0.1">10％OFFクーポン</option>
                            <option value="0.15">15％OFFクーポン</option>
                            <option value="0.2">20％OFFクーポン</option>
                            <option value="0.25">25％OFFクーポン</option>
                            <option value="0.3">30％OFFクーポン</option>
                        </select>
                    </div>
                    <div>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="referral-discount" name="referral-discount" class="form-checkbox h-5 w-5 text-[#E4C1B5] rounded focus:ring-[#ad9196]">
                            <span class="font-medium">紹介割引を利用する</span>
                        </label>
                        <p class="text-sm mt-1">ご紹介くださった方と紹介された方を対象に割引できます。他クーポン併用可 (-500円)</p>
                    </div>
                </div>
            </div>

            <!-- お支払い方法 -->
            <div class="content-card fade-in">
                 <h2 class="text-xl font-semibold mb-4 text-center">お支払い・備考</h2>
                <div>
                    <label for="payment-method" class="block mb-2 font-medium required-star">お支払い方法</label>
                    <select id="payment-method" name="payment-method" class="form-select" required>
                        <option value="">選択してください</option>
                        <option value="bank">銀行振込</option>
                        <option value="paypay">Paypay</option>
                        <option value="paypal">Paypal</option>
                        <option value="credit">クレジットカード</option>
                        <option value="konbini">コンビニ払い（手数料220円）</option>
                    </select>
                </div>
                 <div class="mt-4">
                    <label for="remarks" class="block mb-2 font-medium">備考</label>
                    <textarea id="remarks" name="remarks" rows="4" placeholder="ご希望・ご質問があればご記入ください" class="form-textarea"></textarea>
                </div>
            </div>
        </form>
        
        <!-- ご確認事項 -->
        <div class="content-card fade-in space-y-6">
            <h2 class="text-xl font-semibold text-center">ご確認事項</h2>
            <div>
                <h3 class="font-bold text-lg mb-2">セッションについて</h3>
                <ul class="list-disc list-inside space-y-1">
                    <li>セッション形式： 遠隔</li>
                    <li>ご予約： 日にち指定のみ（時間指定不可）</li>
                </ul>
            </div>
            <div>
                <h3 class="font-bold text-lg mb-2">納品日・営業時間</h3>
                <ul class="list-disc list-inside space-y-1">
                    <li>納品日：セッション日より5営業日</li>
                    <li>営業時間： 9：00～17：00</li>
                    <li>休日：土日祝日、他指定日</li>
                </ul>
            </div>
            <div>
                <h3 class="font-bold text-lg mb-2">セッション後の追加料金について</h3>
                <p>納品後に、追加の相談がある場合、追加料金が発生いたします。<br>ご相談１件：3,000円～</p>
            </div>
            <div>
                <h3 class="font-bold text-lg mb-2">【ご提出いただくもの】</h3>
                <p>ご予約後、LINEにて以下の3点をお送りください。</p>
                <ul class="list-disc list-inside space-y-1 mt-1">
                    <li>目元の写真</li>
                    <li>手書きのお名前</li>
                    <li>手書きの深掘りしたいことのタイトル</li>
                </ul>
                <div class="flex flex-col sm:flex-row gap-4 mt-4 justify-center">
                    <img src="https://github.com/therapist-mii/spiritual/raw/main/images/memoto.jpg" alt="目元の写真例" class="w-full sm:w-1/2 rounded-lg shadow-md">
                    <img src="https://github.com/therapist-mii/spiritual/raw/main/images/tegaki-r.jpg" alt="手書きの例" class="w-full sm:w-1/2 rounded-lg shadow-md">
                </div>
            </div>
        </div>

        <!-- 見積もり表示 -->
        <div id="estimate-output" class="content-card fade-in text-lg">
            <h2 class="text-2xl font-bold mb-4 text-center border-b pb-2">【アートセラピーお見積り】</h2>
            <div id="estimate-details" class="space-y-2">
                <!-- 計算結果がここに表示されます -->
            </div>
        </div>

        <!-- アクションボタン -->
        <div class="fade-in space-y-4 text-center mt-8">
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                 <button type="button" id="copy-btn" class="btn btn-primary">お見積りをコピー</button>
                 <a href="https://line.me/ti/p/Kv76GQK_UI" target="_blank" rel="noopener noreferrer" id="line-btn" class="btn btn-primary bg-green-500 hover:bg-green-600 inline-block">LINEに貼り付けて予約する</a>
            </div>
        </div>

        <!-- LINE予約手順 -->
        <div class="content-card fade-in mt-8">
            <h2 class="text-xl font-semibold mb-4 text-center">【LINEで予約する際の手順】</h2>
            <ol class="list-decimal list-inside space-y-2">
                <li>お見積り内容にご了承いただけましたら、「お見積りをコピー」ボタンを押し、お見積り内容をコピーしてください。</li>
                <li>「LINEに貼り付けて予約する」ボタンを押し、起動したLINEに貼り付けて送信ください。</li>
            </ol>
        </div>
        
        <!-- ナビゲーション -->
        <div class="content-card fade-in mt-8 text-center space-y-6">
            <div>
                <h2 class="text-xl font-semibold mb-2">はじめての方へ</h2>
                <p class="mb-4">はじめての方は、以下のフォームにご記入お願いいたします。リピーター様も未入力の方はご記入お願いいたします。</p>
                <a href="https://spiritual-therapist-mii.studio.site/form" target="_blank" rel="noopener noreferrer" class="btn btn-secondary inline-block">はじめての方のフォーム</a>
            </div>
            <div class="flex justify-center gap-4">
                 <a href="https://spiritual-therapist-mii.studio.site/" target="_blank" rel="noopener noreferrer" class="btn btn-primary">Home</a>
                 <a href="https://spiritual-therapist-mii.studio.site/menu" target="_blank" rel="noopener noreferrer" class="btn btn-primary">メニュー一覧</a>
            </div>
        </div>
    </main>

    <!-- フッター -->
    <footer class="py-8 mt-8 flex justify-center">
         <a href="https://spiritual-therapist-mii.studio.site/" target="_blank" rel="noopener noreferrer">
            <img src="https://github.com/therapist-mii/spiritual/raw/main/images/rogo-250.png" alt="フッターロゴ" class="w-64 h-auto">
        </a>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 設定 ---
        const config = {
            prices: {
                base: 16000,
                additionalConsultation: 3000,
                relatedPerson: {
                    family: 1500,
                    partner: 5000,
                    other: 3000
                },
                referralDiscount: 500,
            },
            maxRelatedPersons: 5,
        };

        // --- DOM要素 ---
        const form = document.getElementById('estimate-form');
        const cardsContainer = document.getElementById('consultation-cards-container');
        const addConsultationBtn = document.getElementById('add-consultation-btn');
        const estimateOutput = document.getElementById('estimate-output');
        const estimateDetails = document.getElementById('estimate-details');
        const copyBtn = document.getElementById('copy-btn');
        const lineBtn = document.getElementById('line-btn');
        const errorMessage = document.getElementById('error-message');
        
        let consultationCardIdCounter = 0;

        // --- 関数 ---

        /** 相談カードのHTMLテンプレート */
        const createConsultationCardHTML = (id, isFirstCard = false) => `
            <div class="content-card fade-in" id="card-${id}" data-card-id="${id}">
                ${!isFirstCard ? `
                <button type="button" class="absolute top-2 right-2 h-8 w-8 rounded-full flex items-center justify-center btn-clear-wrapper remove-card-btn" data-remove-target="card-${id}">
                    <span class="text-xl font-bold btn-clear-text">&times;</span>
                </button>` : ''}
                <div class="space-y-4">
                    <div>
                        <label for="content-${id}" class="block mb-2 font-medium required-star">深掘りしたい内容</label>
                        <textarea id="content-${id}" name="content-${id}" rows="3" placeholder="例：私の心の奥深くには何があるのでしょうか？" class="form-textarea" required></textarea>
                        <p class="text-sm mt-1">要点のみご記入ください。</p>
                    </div>
                    ${isFirstCard ? `
                    <div>
                        <label for="client-name-${id}" class="block mb-2 font-medium">ご依頼人名</label>
                        <input type="text" id="client-name-${id}" name="client-name-${id}" placeholder="お名前" class="form-input">
                    </div>
                    ` : ''}
                </div>
                <div class="mt-6">
                    <h3 class="font-semibold mb-2">関係する方（依頼人以外）</h3>
                    <p class="text-sm mb-4">人間関係のお相手など、鑑定結果に言及する必要のある方のお名前（ニックネーム可）。最大${config.maxRelatedPersons}名まで</p>
                    <div id="related-persons-container-${id}" data-card-id="${id}" class="space-y-3"></div>
                    <div class="mt-4 flex justify-between items-center">
                        <button type="button" class="text-[#E4C1B5] hover:text-[#ad9196] font-semibold add-related-person-btn" data-card-id="${id}">+ 関係者を追加</button>
                        <span class="text-sm">人数: <span id="related-person-count-${id}">0</span> / ${config.maxRelatedPersons}</span>
                    </div>
                </div>
            </div>
        `;

        /** 関係者入力欄のHTMLテンプレート */
        const createRelatedPersonHTML = (cardId, personId) => `
            <div class="p-3 border rounded-lg bg-gray-50/50 fade-in flex flex-col sm:flex-row gap-3 items-center" id="related-person-${cardId}-${personId}">
                <div class="w-full sm:w-2/5">
                    <label for="related-name-${cardId}-${personId}" class="sr-only">名前</label>
                    <input type="text" id="related-name-${cardId}-${personId}" name="related-name-${cardId}-${personId}" placeholder="名前" class="form-input related-name">
                </div>
                <div class="w-full sm:w-2/5">
                     <label for="related-relation-${cardId}-${personId}" class="sr-only">関係性</label>
                    <select id="related-relation-${cardId}-${personId}" name="related-relation-${cardId}-${personId}" class="form-select related-relation">
                        <option value="">関係性を選択</option>
                        <option value="family">家族</option>
                        <option value="partner">恋愛のお相手</option>
                        <option value="other">その他の関係</option>
                    </select>
                </div>
                <div class="w-full sm:w-1/5 flex justify-end">
                    <button type="button" class="h-8 w-8 rounded-full flex items-center justify-center bg-gray-200 hover:bg-gray-300 text-gray-600 remove-related-person-btn" data-card-id="${cardId}" data-remove-target="related-person-${cardId}-${personId}">&times;</button>
                </div>
            </div>
        `;

        /** 相談カードを追加 */
        const addConsultationCard = () => {
            const cardId = consultationCardIdCounter++;
            const isFirst = cardId === 0;
            const cardHTML = createConsultationCardHTML(cardId, isFirst);
            cardsContainer.insertAdjacentHTML('beforeend', cardHTML);
            calculateAndDisplayEstimate();
        };

        /** 関係者を追加 */
        const addRelatedPerson = (cardId) => {
            const container = document.getElementById(`related-persons-container-${cardId}`);
            const countSpan = document.getElementById(`related-person-count-${cardId}`);
            if (!container || !countSpan) return;

            const currentCount = container.children.length;
            if (currentCount >= config.maxRelatedPersons) {
                alert(`関係者は最大${config.maxRelatedPersons}名までです。`);
                return;
            }

            const personId = Date.now(); // ユニークID
            const personHTML = createRelatedPersonHTML(cardId, personId);
            container.insertAdjacentHTML('beforeend', personHTML);
            countSpan.textContent = currentCount + 1;
            calculateAndDisplayEstimate();
        };
        
        /** 要素を削除 */
        const removeElement = (targetId, cardId = null) => {
            const element = document.getElementById(targetId);
            if (element) {
                element.remove();
            }
             if (cardId !== null) {
                const container = document.getElementById(`related-persons-container-${cardId}`);
                const countSpan = document.getElementById(`related-person-count-${cardId}`);
                if (container && countSpan) {
                    countSpan.textContent = container.children.length;
                }
            }
            calculateAndDisplayEstimate();
        };


        /** 見積もり計算と表示 */
        const calculateAndDisplayEstimate = () => {
            let total = 0;
            let subTotals = {
                base: 0,
                additional: 0,
                related: [],
                couponDiscount: 0,
                referralDiscount: 0
            };

            const consultationCards = cardsContainer.querySelectorAll('.content-card');
            
            if (consultationCards.length > 0) {
                subTotals.base = config.prices.base;
                total += config.prices.base;
            }
            if (consultationCards.length > 1) {
                subTotals.additional = (consultationCards.length - 1) * config.prices.additionalConsultation;
                total += subTotals.additional;
            }

            consultationCards.forEach(card => {
                const relatedPersons = card.querySelectorAll('[id^="related-person-"]');
                relatedPersons.forEach(person => {
                    const nameInput = person.querySelector('.related-name');
                    const relationSelect = person.querySelector('.related-relation');
                    // FIX: Add null checks for both elements before trying to access their 'value' property.
                    if (nameInput && relationSelect && nameInput.value.trim() !== '' && relationSelect.value !== '') {
                        const price = config.prices.relatedPerson[relationSelect.value];
                        // FIX: Ensure price is a number before adding to total to prevent NaN issues.
                        if (typeof price === 'number') {
                            total += price;
                            subTotals.related.push({ name: nameInput.value.trim(), price });
                        }
                    }
                });
            });
            
            let priceBeforeDiscount = total;

            const couponValue = parseFloat(document.getElementById('coupon').value);
            if (couponValue > 0) {
                subTotals.couponDiscount = Math.round(priceBeforeDiscount * couponValue);
                total -= subTotals.couponDiscount;
            }

            if (document.getElementById('referral-discount').checked) {
                subTotals.referralDiscount = config.prices.referralDiscount;
                total -= subTotals.referralDiscount;
            }
            
            // --- 表示更新 ---
            let html = `<h2 class="text-2xl font-bold mb-4 text-center border-b pb-2">【アートセラピーお見積り】</h2>`;
            let textForCopy = "【アートセラピーお見積り】\n\n";

            if (consultationCards.length > 0) {
                html += `<p class="flex justify-between"><span>アートセラピー基本料:</span> <span>${config.prices.base.toLocaleString()} 円</span></p>`;
                textForCopy += `アートセラピー基本料: ${config.prices.base.toLocaleString()} 円\n`;
            }
            if (subTotals.additional > 0) {
                html += `<p class="flex justify-between"><span>追加相談料 (${consultationCards.length - 1}件):</span> <span>${subTotals.additional.toLocaleString()} 円</span></p>`;
                 textForCopy += `追加相談料 (${consultationCards.length - 1}件): ${subTotals.additional.toLocaleString()} 円\n`;
            }

            if(subTotals.related.length > 0) {
                html += `<div class="pl-4 mt-1 border-l-2">`;
                textForCopy += "\n関係者霊視接続料:\n";
                subTotals.related.forEach(p => {
                    html += `<p class="flex justify-between text-sm"><span>${p.name} 様:</span> <span>${p.price.toLocaleString()} 円</span></p>`;
                    textForCopy += `  ${p.name} 様: ${p.price.toLocaleString()} 円\n`;
                });
                html += `</div>`;
            }
            
             if (subTotals.couponDiscount > 0 || subTotals.referralDiscount > 0) {
                html += `<div class="my-2"></div>`;
                textForCopy += "\n";
            }

            if (subTotals.couponDiscount > 0) {
                const percent = couponValue * 100;
                html += `<p class="flex justify-between text-green-600"><span>クーポン割引 (${percent}%):</span> <span>-${subTotals.couponDiscount.toLocaleString()} 円</span></p>`;
                textForCopy += `クーポン割引 (${percent}%): -${subTotals.couponDiscount.toLocaleString()} 円\n`;
            }
            if (subTotals.referralDiscount > 0) {
                html += `<p class="flex justify-between text-green-600"><span>紹介割引:</span> <span>-${subTotals.referralDiscount.toLocaleString()} 円</span></p>`;
                textForCopy += `紹介割引: -${subTotals.referralDiscount.toLocaleString()} 円\n`;
            }
            
            html += `<hr class="my-4">`;
            textForCopy += "--------------------------------\n";
            
            html += `<p class="flex justify-between font-bold text-2xl"><span>合計金額:</span> <span>${Math.max(0, total).toLocaleString()} 円</span></p>`;
            textForCopy += `合計金額: ${Math.max(0, total).toLocaleString()} 円\n`;
            
            const paymentMethod = document.getElementById('payment-method').value;
            if (paymentMethod === 'konbini') {
                 html += `<p class="text-sm text-right mt-1">※コンビニ払い手数料220円が別途かかります。</p>`;
                 textForCopy += "※コンビニ払い手数料220円が別途かかります。\n";
            }
            
            estimateDetails.innerHTML = html;
            estimateDetails.dataset.copyText = textForCopy;
        };
        
        /** フォームバリデーション */
        const validateForm = () => {
            clearErrors();
            const requiredFields = form.querySelectorAll('[required]');
            let firstInvalidField = null;
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    field.classList.add('error');
                    if (!firstInvalidField) {
                        firstInvalidField = field;
                    }
                }
            });

            // 関係者のバリデーション
            const relatedNameInputs = form.querySelectorAll('.related-name');
            relatedNameInputs.forEach(input => {
                if (input.value.trim() !== '') {
                    // FIX: Safely find the related select element and check its value
                    const parentPersonDiv = input.closest('[id^="related-person-"]');
                    if (parentPersonDiv) {
                        const relationSelect = parentPersonDiv.querySelector('.related-relation');
                        if (relationSelect && relationSelect.value === '') {
                             isValid = false;
                             relationSelect.classList.add('error');
                             if (!firstInvalidField) {
                                firstInvalidField = relationSelect;
                            }
                        }
                    }
                }
            });


            if (!isValid) {
                errorMessage.classList.remove('hidden');
                if (firstInvalidField) {
                    firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            } else {
                errorMessage.classList.add('hidden');
            }

            return isValid;
        };

        /** エラー表示をクリア */
        const clearErrors = () => {
            errorMessage.classList.add('hidden');
            form.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
        };

        /** クリップボードにコピー */
        const copyToClipboard = () => {
            if (!validateForm()) return;

            const textToCopy = estimateDetails.dataset.copyText;
            
            // Create a temporary textarea element to hold the text
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            
            // Make it invisible and append it to the body
            textArea.style.position = 'fixed';
            textArea.style.top = '-9999px';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            
            // Select the text and copy it
            textArea.select();
            textArea.setSelectionRange(0, 99999); // For mobile devices

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    copyBtn.textContent = 'コピーしました！';
                    setTimeout(() => {
                        copyBtn.textContent = 'お見積りをコピー';
                    }, 2000);
                } else {
                    console.error('Fallback: コピーコマンドが失敗しました。');
                }
            } catch (err) {
                console.error('Fallback: コピー中にエラーが発生しました。', err);
            }
            
            // Remove the temporary element
            document.body.removeChild(textArea);
        };

        // --- イベントリスナー ---
        form.addEventListener('input', calculateAndDisplayEstimate);
        form.addEventListener('change', calculateAndDisplayEstimate);

        addConsultationBtn.addEventListener('click', addConsultationCard);
        
        cardsContainer.addEventListener('click', (e) => {
            if (e.target.closest('.add-related-person-btn')) {
                const cardId = e.target.closest('.add-related-person-btn').dataset.cardId;
                addRelatedPerson(cardId);
            }
            if (e.target.closest('.remove-card-btn')) {
                const targetId = e.target.closest('.remove-card-btn').dataset.removeTarget;
                removeElement(targetId);
            }
            if (e.target.closest('.remove-related-person-btn')) {
                const button = e.target.closest('.remove-related-person-btn');
                const targetId = button.dataset.removeTarget;
                const cardId = button.dataset.cardId;
                removeElement(targetId, cardId);
            }
        });

        copyBtn.addEventListener('click', copyToClipboard);
        lineBtn.addEventListener('click', (e) => {
            if(!validateForm()) {
                e.preventDefault();
            }
        });

        // --- 初期化 ---
        addConsultationCard();

    });
    </script>
</body>
</html>

